---
title: RocketMQ架构设计
date: 2023-01-01 00:00:00
tags: 
  - RocketMQ
  - 消息队列
categories: 
  - RocketMQ
description: RocketMQ架构设计
toc_number: false
author:
  name: huidong.yin
  link: https://huidongyin.github.io
permalink: /pages/eba85197-e655-32cf-acc3-13b5fa2f8c26/
---

## 一，RocketMQ源码目录结构
RocketMQ源码基于Maven模块的组织结构。
![image.png](https://raw.githubusercontent.com/huidongyin/DrawingBed/main/RocketMQ/202311052146893.png)

---

## 二，RocketMQ的设计理念
RocketMQ设计基于主题的发布与订阅模式，其核心功能包括消息发送，消息存储和消息消费，整体设计追求简单和性能高效。

1. 对于数据一致性的容忍
- NameServer摒弃了业界常用的Zk作为消息管理的注册中心，而是自研实现元数据的管理（topic路由信息等）。从实际需求出发，topic路由信息无需在集群之间保持强一致，而是追求最终一致性，并且可以容忍分钟级别的不一致。正是基于这种特性，RocketMQ的NameServer集群之间互不通信，这样极大的降低了NameServer实现的复杂度，对网络的要求也降低了不少，性能相比zk还有了很大的提升。
2. 高效的IO存储机制
- RocketMQ追求消息发送的高吞吐量，RocketMQ的消息存储文件被设计成文件组的概念，组内单个文件大小固定，方便引入内存映射机制，所有主题的消息存储按顺序编写，极大的提升了消息的写性能。同时为了兼顾消息消费与消息查找，引入了消息消费队列文件与索引文件。
3. 容忍存在设计缺陷
- 适当将某些工作下放给RocketMQ的使用者，只保证消息被消费者消费，在设计上允许消息被重复消费，简化了消息中间件的内核。

---

## 三，设计目标
### 1.架构模式
RocketMQ与大部分消息队列一样，采用订阅发布模型，主要组件包括：消息发送者，消息服务器，消息消费和路由发现。

---

### 2.顺序消息
RocketMQ可以严格保证消息有序。

---

### 3.消息过滤
消息过滤指的是在消费消息时，消息消费者可以对同一个Topic下的消息按照规则只消费自己感兴趣的消息。RocketMQ消息过滤是服务端和消费端共同完成的。

---

### 4.消息存储
消息存储的考量一般有两点：**消息堆积能力**和**消息存储性能**。RocketMQ追求消息存储的高性能，引入内存映射机制，所有主题的消息按顺序存储在同一文件中。同时为了避免消息在消息存储服务器中无限的累积，引入了消息文件过期机制和文件存储空间报警机制。

---

### 5.消息高可用性
影响消息可靠性的有以下几种情况：

1. broker异常崩溃。
2. 操作系统崩溃。
3. 机器断电，但是可以立即恢复供电。
4. 机器无法开机。
5. 磁盘损坏。

对于前三种，RocketMQ在同步刷盘模式下可以确保消息不丢失，异步刷盘模式下会丢失少量消息。后面的两种单点故障，一旦发生，该节点的消息会全部丢失。如果开启了异步复制机制，RocketMQ能保证只丢失少量消息。

---

### 6.消息消费低延迟
RocketMQ在消息不发生堆积时，以长轮训模式实现准实时的消息推送模式。

---

### 7.确保至少被消费一次
RocketMQ通过ACK机制确保消息至少被消费一次，因为ACK消息可能会出现丢失的情况，RocketMQ无法做到消息只被消费一次，所以有重复消费的可能。

---

### 8.回溯消息
回溯消息：消息已经被成功消费，但是业务方期望可以重新消费消息。
RocketMQ支持按照时间向前或向后回溯消息，时间维度可精确到毫秒。

---

### 9.消息堆积
RocketMQ使用磁盘文件存储消息（内存映射机制），并且在物理布局上为多个大小相等的文件组成逻辑文件组，可以无限循环使用。RocketMQ消息存储文件并不是永久存储在消息服务器端的，而是提供了过期机制，默认保留三天。

---

### 10.定时消息
如果要支持任意精度的定时消息消费，就必须在消息服务端对消息进行排序，这会带来很大的性能损耗，所以RocketMQ不支持任意进度的定时消息，只支持特定延迟级别。

---

### 11.消息重试
RocketMQ支持消息重试机制。消息重试是指在消息消费如果发生异常，消息中间件支持消息重新投递。

---


