---
title: Zookeeper核心概念
date: 2023-01-01 00:00:00
tags: 
  - Zookeeper
  - 中间件
categories: 
  - Zookeeper
description: Zookeeper核心概念
toc_number: false
author:
  name: huidong.yin
  link: https://huidongyin.github.io
permalink: /pages/439fd0f9-b80a-3cd0-88de-269bfa26cea4/
---

## 1.Zookeeper的特点

上文中已经说了 ZooKeeper 是分布式的注册中心、分布式的协调中心。只要是分布式，就会有几个通用的特点，比如：一致性、实时性、高可用性等。那 Zookeeper 这个中间件都实现了哪些特点呢？接下来我们逐个分析。

第一个特点就是支持**分布式集群部署**，这个在上一篇文章中也介绍过了。

第二个特点是顺序一致性。什么叫**顺序一致性**？就是客户端发送的每一次请求到 ZooKeeper 的时候都是有序的，在整个集群内也是有序的。

比如：client1 先发送了一个请求到 ZooKeeper，client2 也发送了一个请求，那么这两个请求在 ZooKeeper 服务端处理的时候是有序的，且 Leader 同步给其他 Follower 的时候也是有序的。ZooKeeper 是如何实现这个特点的呢？ZooKeeper 给每个请求都编了一个号，比如第一次请求就叫 `zxid-1`，第二次请求就递增，叫 `zxid-2`……以此类推。可参考下面的示意图：

!()[https://raw.githubusercontent.com/huidongyin/DrawingBed/main/Zookeeper/202312122258824.png]

第三个特点是**原子性**，要么写入成功，要么失败。这里指的是一次请求在整个分布式集群中具备原子性，即要么整个集群中所有 ZooKeeper 节点都成功地处理了这个请求，要么就都没有处理，绝对不会出现集群中一部分 ZooKeeper 节点处理了这个请求，而另一部分节点没有处理的情况。

第四个是**可靠性**，如果某台机器宕机，要保证数据绝对不能丢失。这里又分为两种情况。

1. 如果同步给 Follower 后，Leader 挂机了怎么办？这种简单呀，Follower 选举为 Leader 就好啦，反正数据同步给 Follower 了。
2. 如果 Leader 收到半数以上的 Follower 的 ack 了，自己先写入了 znode，然后还没发 Commit 呢，这时候宕机了，怎么办？这时候会先选举 Leader，选举规则是 zxid 最大的优先被选举，然后当老 Leader 恢复后会和新 Leader 对比，发现多了一条无用消息（宕机之前写入 znode 的那条），这时候会丢掉这个消息，且自己退位为 Follower 重新和新 Leader 同步数据。

第五个是**实时性**，也就是说一旦数据发生变化，那要及时通知给客户端。这个采取的是 Watcher 监听机制，我们在后面的文章中会详细剖析监听机制的思想和源码。

到这里 ZooKeeper 的这五大特点我们就都介绍完了。在前面讲述过程中，我们多次提到了 Leader 和 Follower，这两个单词是什么鬼？其实，它们都属于 ZooKeeper 的角色，那 ZooKeeper 都有哪些角色呢？下面我们就来一起看下。

---

## 2.Zookeeper的角色

ZooKeeper 总共有三种角色，前两种肯定是我们一直提到的 **Leader** 和 **Follower** 了，那最后一种是什么呢？是 **Observer**。

这三个单词直接放到这里你可能有点蒙圈，下面我们就用最通俗易懂的语言来描述下！

1. **Leader**：Leader 是核心，也就是分布式系统中最常用的 Master。Leader 提供读写能力，且写请求只能由 Leader 来完成；每一次写请求都会生成一个 zxid，然后将此请求同步给各个 Follower 和 Observer，这个 zxid 也是决定顺序一致性的关键所在。

> Leader 是集群之首，读写都可以提供，且写请求只能由 Leader 来完成，也负责将写请求的数据同步给各个节点。

2. **Follower**：Follower 是分布式系统中常说的从节点，它只提供读请求的能力；如果写请求到 Follower 上了，那么 Follower 会将此请求转发到 Leader，由 Leader 来完成写入，再同步给 Follower。Follower 不只提供读能力，还额外负责选举，也就是比如 Leader 挂了的话，Follower 是有资格成为 Leader 的。

> Follower 是从节点的概念，仅提供读能力，且有资格参与选举。

3. **Observer**：它可以直接提升我们 ZooKeeper 集群的并发读能力。Observer 也只提供读能力，它和 Follower 的差别在于 Observer 没资格竞争 Leader 的选举，也就是 Leader 挂了的话，Observer 是不会被选举为 Leader 的，并且也没资格给选举投票。它只会接收 Leader 的同步数据，然后提供给读请求。为了提升高并发读能力，肯定是不能太多 Follower 的，因为每次写操作都要同步到 Follower 等待确认，所以 Follower 一般 3～4 个就好了，多增加 Observer 来提升读的并发能力。但是写的 QPS 能力是无法提升的，只有 Leader 来写，同步到其他节点。

> Observer也是从节点的概念，仅提供读能力，但是没有资格参与选举并且不需要跟Leader确认写操作，这是和 Follower 的差别所在。合理利用 Observer 可以提供集群的读并发能力。


下面用一张简图总结下这三种角色：

![](https://raw.githubusercontent.com/huidongyin/DrawingBed/main/Zookeeper/202312122307808.png)

---

## 3.Zookeeper的节点类型

在看有哪些节点类型之前，我们需要先代入一个小知识点：什么是节点？

其实很简单，你可以将节点理解成 ZooKeeper 存储数据的数据结构。ZooKeeper 把数据都存储到内存里了，数据格式为 znode，至于 znode 长什么样我们先不关心，只需知道 ZooKeeper 的节点就是 znode，znode就是存数据的地方。这就够了。

那再来看什么是节点类型。ZooKeeper 有两种节点类型：**持久节点**和**临时节点**。

- **持久节点**：即使客户端断开连接，那么此节点也一直存在。

- **临时节点**：如果客户端断开连接，此时它之前创建的临时节点就会自动消失、自动删除掉。所以说，如果客户端采取 ZooKeeper 的 watch 机制监听了这个临时节点，那么这个临时节点一旦被删除，客户端就会立即收到一个“临时节点已删除”的通知，这时候就可以处理一些自己的业务逻辑。

那什么时候用持久节点？什么时候用临时节点呢？

如果是做元数据存储，那肯定是持久节点。比如 Kafka，用 ZooKeeper 来维护 topic，那么连接断开后 topic 就被删除了吗？肯定不可以的！所以如果做元数据存储，建议是持久节点。

如果是做一些分布式协调和通知工作，那大多数是用临时节点的。比如，我创建一个临时节点，别人来监听这个节点的变化；如果我断开连接，那么临时节点自动删除，此时监听我这个临时节点的客户端就会立即感知到。

总结来说：**持久节点就是持久化的，连接断开后数据也不会丢失；临时节点是基于内存的，连接断开后，节点就被删除了，数据也就随之丢失了。**

网上部分文章还提出了一个顺序节点的概念，其实这个说法从严格意义上来讲是错误的。所谓的顺序节点只是一种修饰状态，它可以跟持久节点与临时节点组合成：顺序持久节点、顺序临时节点。

那何为顺序呢？举个例子：在`/my/test`下创建临时顺序节点，那么就会自动创建子节点，子节点自动进行编号，`0000000001`、`0000000002`……每次自增。这就是顺序。

那顺序有什么用呢？公平性可以用。比如，Curator 客户端实现公平的分布式锁就是采取的“顺序临时节点+Watcher 监听”的方式来完成的。

---

## 4.什么是节点

上节提到：**节点就是 znode，是 ZooKeeper 保存数据的地方。**

这里我们重新给它下个定义：ZooKeeper 会维护一个具有层次关系的数据结构，这个数据结构和标准文件系统的名称空间非常相似，类似于一个分布式文件系统，每个节点都是一个路径作为唯一标识，每个节点都可以多层级，且可以包含数据，也就是说**每个节点都可以由多层节点+数据组成**。其数据部分叫作数据节点 znode，每个 znode 大小有限，默认可以存储 1MB 数据。

我们先看下图：

![](https://raw.githubusercontent.com/huidongyin/DrawingBed/main/Zookeeper/202312122323450.jpeg)

上图中每个圆圈和每个六边形都叫节点，`/，/app1，/app2`属于三个根节点，`/app1/p_1`属于`/app1`节点的子节点，看起来就跟 Linux 文件系统一样。

比如，我们创建一个`/helloworld/v1`节点，且数据为 1，如下：

```bash

```