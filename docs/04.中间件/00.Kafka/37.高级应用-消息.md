---
title: 高级应用-消息
date: 2023-01-01 00:00:00
tags:
    - Kafka
    - 消息队列
categories:
    - Kafka
description: 高级应用-消息
toc_number: false
author:
name: huidong.yin
link: https://huidongyin.github.io
permalink: /pages/e923632b-cefb-324f-8e00-ba7c2f6f1073/

---

## 1.消息路由

消息路由是消息中间件中常见的一个概念， 比如在典型的消息中间件Rabbit MQ中就使用路由键Routing Key来进行消息路由。如图所示， Rabbit MQ中的生产者将消息发送到交换器Exchange中， 然后由交换器根据指定的路由键来将消息路由到一个或多个队列中， 消费者消费的是队列中的消息。从整体上而言， Rabbit MQ通过路由键将原本发往一个地方的消息做了区分，然后让不同的消息者消费到自己要关注的消息。

![11-9](https://raw.githubusercontent.com/huidongyin/DrawingBed/main/Kafka/202312192340915.png)

Kafka默认按照主题进行路由， 也就是说， 消息发往主题之后会被订阅的消费者全盘接收，这里没有类似消息路由的功能来将消息进行二级路由，这一点从逻辑概念上来说并无任何问题。从业务应用上而言，如果不同的业务流程复用相同的主题，就会出现消息接收时的混乱，这种问题可以从设计上进行屏蔽，如果需要消息路由，那么完全可以通过细粒度化切分主题来实现。

除了设计缺陷， 还有一些历史遗留的问题迫使我们期望Kafka具备一个消息路由的功能。如果原来的应用系统采用了类似Rabbit MQ这种消息路由的生产消费模型， 运行一段时间之后又需要更换为Kafka， 并且变更之后还需要保留原有系统的编程逻辑。对此， 我们首先需要在这个整体架构中做一层关系映射， 如图所示。这里将Kafka中的消费组与Rabbit MQ中的队列做了一层映射， 可以根据特定的标识来将消息投递到对应的消费组中， 按照Kafka中的术语来讲，消费组根据消息特定的标识来获取消息，其余的都可以被过滤。

![11-10](https://raw.githubusercontent.com/huidongyin/DrawingBed/main/Kafka/202312192346899.png)

具体的实现方式可以在消息的headers字段中加入一个键为`routing key`、值为特定业务标识的Header， 然后在消费端中使用拦截器挑选出特定业务标识的消息。Kafka中消息路由的实现架构如图所示， 消费组Consumer Group 根据指定的Header标识`rk 2`和`rk 3`来消费主题Topic A和Topic B中所有对应的消息而忽略Header标识为`rk 1`的消息， 消费组Consumer Group 2 正好相反。

![11-11](https://raw.githubusercontent.com/huidongyin/DrawingBed/main/Kafka/202312192355473.png)

这里只是演示作为消息中间件家族之一的Kafka如何实现消息路由的功能， 不过消息路由在Kafka的使用场景中很少见， 如无特殊需要， 也不推荐刻意地使用它。

---

## 2.消息轨迹


---

## 3.消息审计


---

## 4.消息代理

---
