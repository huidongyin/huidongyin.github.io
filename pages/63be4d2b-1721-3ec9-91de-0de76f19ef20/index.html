<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>RocketMQ基础入门 | Huidong Blogs</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/img/logo.jpg">
    <script>var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?b4efcb3b959fd674ffa886696241c972";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>
    <meta name="description" content="RocketMQ基础入门">
    <meta name="keywords" content="Huidong Blogs">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.2b7af6e1.css" as="style"><link rel="preload" href="/assets/js/app.c004ce88.js" as="script"><link rel="preload" href="/assets/js/4.beb5e9d1.js" as="script"><link rel="preload" href="/assets/js/1.39930c36.js" as="script"><link rel="preload" href="/assets/js/3.95e91fe0.js" as="script"><link rel="preload" href="/assets/js/152.dff556f3.js" as="script"><link rel="prefetch" href="/assets/js/10.af4ee541.js"><link rel="prefetch" href="/assets/js/100.be469ed8.js"><link rel="prefetch" href="/assets/js/101.0de873a0.js"><link rel="prefetch" href="/assets/js/102.b0af2aaa.js"><link rel="prefetch" href="/assets/js/103.5054ee81.js"><link rel="prefetch" href="/assets/js/104.53b53477.js"><link rel="prefetch" href="/assets/js/105.dca5cd95.js"><link rel="prefetch" href="/assets/js/106.8256a53d.js"><link rel="prefetch" href="/assets/js/107.cf51d929.js"><link rel="prefetch" href="/assets/js/108.62a55f05.js"><link rel="prefetch" href="/assets/js/109.465bfd72.js"><link rel="prefetch" href="/assets/js/11.51845375.js"><link rel="prefetch" href="/assets/js/110.bb947406.js"><link rel="prefetch" href="/assets/js/111.9de08c2d.js"><link rel="prefetch" href="/assets/js/112.189017f4.js"><link rel="prefetch" href="/assets/js/113.856b958e.js"><link rel="prefetch" href="/assets/js/114.03c1d12d.js"><link rel="prefetch" href="/assets/js/115.13d5e070.js"><link rel="prefetch" href="/assets/js/116.f9c4de66.js"><link rel="prefetch" href="/assets/js/117.2ad66b04.js"><link rel="prefetch" href="/assets/js/118.c14dce6b.js"><link rel="prefetch" href="/assets/js/119.cff4fc42.js"><link rel="prefetch" href="/assets/js/12.7f055be5.js"><link rel="prefetch" href="/assets/js/120.68a9a1da.js"><link rel="prefetch" href="/assets/js/121.fec7d92f.js"><link rel="prefetch" href="/assets/js/122.394158e5.js"><link rel="prefetch" href="/assets/js/123.95881f7a.js"><link rel="prefetch" href="/assets/js/124.c2a8fc0a.js"><link rel="prefetch" href="/assets/js/125.63f16066.js"><link rel="prefetch" href="/assets/js/126.f668bb85.js"><link rel="prefetch" href="/assets/js/127.e18e8fa6.js"><link rel="prefetch" href="/assets/js/128.0ab8af21.js"><link rel="prefetch" href="/assets/js/129.8afca988.js"><link rel="prefetch" href="/assets/js/13.457455c3.js"><link rel="prefetch" href="/assets/js/130.2241a622.js"><link rel="prefetch" href="/assets/js/131.9f5df6f3.js"><link rel="prefetch" href="/assets/js/132.301f3bd2.js"><link rel="prefetch" href="/assets/js/133.ef113ec2.js"><link rel="prefetch" href="/assets/js/134.b02d0aff.js"><link rel="prefetch" href="/assets/js/135.be51ec6b.js"><link rel="prefetch" href="/assets/js/136.41f51a50.js"><link rel="prefetch" href="/assets/js/137.3763b955.js"><link rel="prefetch" href="/assets/js/138.8b8beb84.js"><link rel="prefetch" href="/assets/js/139.1cfc6a25.js"><link rel="prefetch" href="/assets/js/14.a6a77363.js"><link rel="prefetch" href="/assets/js/140.73ad01b3.js"><link rel="prefetch" href="/assets/js/141.b299834e.js"><link rel="prefetch" href="/assets/js/142.41973b10.js"><link rel="prefetch" href="/assets/js/143.86663013.js"><link rel="prefetch" href="/assets/js/144.f5e81b61.js"><link rel="prefetch" href="/assets/js/145.0934b438.js"><link rel="prefetch" href="/assets/js/146.ed214dd0.js"><link rel="prefetch" href="/assets/js/147.2fa0cbba.js"><link rel="prefetch" href="/assets/js/148.d2a209f4.js"><link rel="prefetch" href="/assets/js/149.3576f4cf.js"><link rel="prefetch" href="/assets/js/15.e3984b0f.js"><link rel="prefetch" href="/assets/js/150.8fc92cf9.js"><link rel="prefetch" href="/assets/js/151.b862b99a.js"><link rel="prefetch" href="/assets/js/153.ce70342f.js"><link rel="prefetch" href="/assets/js/154.19365609.js"><link rel="prefetch" href="/assets/js/155.c6f98771.js"><link rel="prefetch" href="/assets/js/156.03a94b0d.js"><link rel="prefetch" href="/assets/js/157.19790efd.js"><link rel="prefetch" href="/assets/js/158.a7af2a81.js"><link rel="prefetch" href="/assets/js/159.ccd71fc2.js"><link rel="prefetch" href="/assets/js/16.65c3e32a.js"><link rel="prefetch" href="/assets/js/160.d532a3c0.js"><link rel="prefetch" href="/assets/js/161.2f05d7a8.js"><link rel="prefetch" href="/assets/js/162.690825ed.js"><link rel="prefetch" href="/assets/js/163.77073e1f.js"><link rel="prefetch" href="/assets/js/164.14349df6.js"><link rel="prefetch" href="/assets/js/165.086c3aad.js"><link rel="prefetch" href="/assets/js/166.b8048819.js"><link rel="prefetch" href="/assets/js/167.16db07bf.js"><link rel="prefetch" href="/assets/js/168.b9e4a477.js"><link rel="prefetch" href="/assets/js/169.b9009b9f.js"><link rel="prefetch" href="/assets/js/17.5233dd36.js"><link rel="prefetch" href="/assets/js/170.d6634a79.js"><link rel="prefetch" href="/assets/js/171.3ce78d04.js"><link rel="prefetch" href="/assets/js/172.d45a9d16.js"><link rel="prefetch" href="/assets/js/173.b6873137.js"><link rel="prefetch" href="/assets/js/174.ba8df863.js"><link rel="prefetch" href="/assets/js/175.c0c7cd5c.js"><link rel="prefetch" href="/assets/js/176.7a6b456d.js"><link rel="prefetch" href="/assets/js/177.f62f9dd5.js"><link rel="prefetch" href="/assets/js/178.44bf7144.js"><link rel="prefetch" href="/assets/js/179.b299c0d8.js"><link rel="prefetch" href="/assets/js/18.bac87b8c.js"><link rel="prefetch" href="/assets/js/180.f57f1828.js"><link rel="prefetch" href="/assets/js/181.653a09a1.js"><link rel="prefetch" href="/assets/js/182.74eebcfd.js"><link rel="prefetch" href="/assets/js/183.c81eb3e1.js"><link rel="prefetch" href="/assets/js/184.b21bee32.js"><link rel="prefetch" href="/assets/js/185.c937fd43.js"><link rel="prefetch" href="/assets/js/186.f3c20037.js"><link rel="prefetch" href="/assets/js/187.208db2fc.js"><link rel="prefetch" href="/assets/js/188.09495a11.js"><link rel="prefetch" href="/assets/js/189.65fb5a30.js"><link rel="prefetch" href="/assets/js/19.ada8a58c.js"><link rel="prefetch" href="/assets/js/190.5f0ade90.js"><link rel="prefetch" href="/assets/js/191.bd602dcd.js"><link rel="prefetch" href="/assets/js/192.04548051.js"><link rel="prefetch" href="/assets/js/193.06ce97a2.js"><link rel="prefetch" href="/assets/js/194.0f1696b0.js"><link rel="prefetch" href="/assets/js/195.ceb818d3.js"><link rel="prefetch" href="/assets/js/196.0584c81b.js"><link rel="prefetch" href="/assets/js/197.56d7e731.js"><link rel="prefetch" href="/assets/js/198.f5bd5a03.js"><link rel="prefetch" href="/assets/js/199.9247b8b6.js"><link rel="prefetch" href="/assets/js/2.bc566a26.js"><link rel="prefetch" href="/assets/js/20.980d2dbe.js"><link rel="prefetch" href="/assets/js/200.dbb38ed4.js"><link rel="prefetch" href="/assets/js/201.dca2dab8.js"><link rel="prefetch" href="/assets/js/202.a043ddd6.js"><link rel="prefetch" href="/assets/js/203.d95996bc.js"><link rel="prefetch" href="/assets/js/204.b0000288.js"><link rel="prefetch" href="/assets/js/205.bc06cebe.js"><link rel="prefetch" href="/assets/js/206.00017456.js"><link rel="prefetch" href="/assets/js/207.32fa7e24.js"><link rel="prefetch" href="/assets/js/208.4cd53c18.js"><link rel="prefetch" href="/assets/js/209.a11ead2c.js"><link rel="prefetch" href="/assets/js/21.7a38785d.js"><link rel="prefetch" href="/assets/js/210.fc0cc7de.js"><link rel="prefetch" href="/assets/js/211.61b0dc42.js"><link rel="prefetch" href="/assets/js/212.b011bd1b.js"><link rel="prefetch" href="/assets/js/213.306a65bf.js"><link rel="prefetch" href="/assets/js/214.d8ba2635.js"><link rel="prefetch" href="/assets/js/215.c3d51219.js"><link rel="prefetch" href="/assets/js/216.260126f3.js"><link rel="prefetch" href="/assets/js/217.0f49295f.js"><link rel="prefetch" href="/assets/js/218.d86b691e.js"><link rel="prefetch" href="/assets/js/219.c7fdeb2f.js"><link rel="prefetch" href="/assets/js/22.aa5d8a5d.js"><link rel="prefetch" href="/assets/js/220.c9a36e7a.js"><link rel="prefetch" href="/assets/js/221.238bd3aa.js"><link rel="prefetch" href="/assets/js/222.02b67dc5.js"><link rel="prefetch" href="/assets/js/223.36387e03.js"><link rel="prefetch" href="/assets/js/224.d5f13731.js"><link rel="prefetch" href="/assets/js/225.a14b8df3.js"><link rel="prefetch" href="/assets/js/226.108e37eb.js"><link rel="prefetch" href="/assets/js/227.a19a99d2.js"><link rel="prefetch" href="/assets/js/228.5bd9926b.js"><link rel="prefetch" href="/assets/js/229.96886fd1.js"><link rel="prefetch" href="/assets/js/23.9fc70572.js"><link rel="prefetch" href="/assets/js/230.5b6fadf1.js"><link rel="prefetch" href="/assets/js/231.f54925ec.js"><link rel="prefetch" href="/assets/js/232.62d049b7.js"><link rel="prefetch" href="/assets/js/233.fd2d8b77.js"><link rel="prefetch" href="/assets/js/234.5623b4ac.js"><link rel="prefetch" href="/assets/js/235.0a33d74c.js"><link rel="prefetch" href="/assets/js/236.ad182da4.js"><link rel="prefetch" href="/assets/js/237.aafee418.js"><link rel="prefetch" href="/assets/js/238.b50c1d89.js"><link rel="prefetch" href="/assets/js/239.09bb7df7.js"><link rel="prefetch" href="/assets/js/24.e4e1e922.js"><link rel="prefetch" href="/assets/js/240.6b141ab4.js"><link rel="prefetch" href="/assets/js/241.1a9c6eed.js"><link rel="prefetch" href="/assets/js/242.031c8aa8.js"><link rel="prefetch" href="/assets/js/25.a328c9f8.js"><link rel="prefetch" href="/assets/js/26.2293b429.js"><link rel="prefetch" href="/assets/js/27.305fb1a5.js"><link rel="prefetch" href="/assets/js/28.df7b03a9.js"><link rel="prefetch" href="/assets/js/29.6096fb93.js"><link rel="prefetch" href="/assets/js/30.95014907.js"><link rel="prefetch" href="/assets/js/31.2de7efa6.js"><link rel="prefetch" href="/assets/js/32.d2e3a33a.js"><link rel="prefetch" href="/assets/js/33.94d8f214.js"><link rel="prefetch" href="/assets/js/34.bcc38932.js"><link rel="prefetch" href="/assets/js/35.df1ad433.js"><link rel="prefetch" href="/assets/js/36.c1f48505.js"><link rel="prefetch" href="/assets/js/37.8a1bba42.js"><link rel="prefetch" href="/assets/js/38.2fed5195.js"><link rel="prefetch" href="/assets/js/39.1dbf0da9.js"><link rel="prefetch" href="/assets/js/40.1e72c882.js"><link rel="prefetch" href="/assets/js/41.a3376d60.js"><link rel="prefetch" href="/assets/js/42.eb1159e8.js"><link rel="prefetch" href="/assets/js/43.7b6e8276.js"><link rel="prefetch" href="/assets/js/44.86116c1f.js"><link rel="prefetch" href="/assets/js/45.7758b554.js"><link rel="prefetch" href="/assets/js/46.e6f82c16.js"><link rel="prefetch" href="/assets/js/47.03711da3.js"><link rel="prefetch" href="/assets/js/48.cc4cf762.js"><link rel="prefetch" href="/assets/js/49.a08ffaab.js"><link rel="prefetch" href="/assets/js/5.d7170a20.js"><link rel="prefetch" href="/assets/js/50.3fc58fc7.js"><link rel="prefetch" href="/assets/js/51.b3f0b709.js"><link rel="prefetch" href="/assets/js/52.1a0c4fb5.js"><link rel="prefetch" href="/assets/js/53.14a44c5e.js"><link rel="prefetch" href="/assets/js/54.7fbc790f.js"><link rel="prefetch" href="/assets/js/55.ed6e65c4.js"><link rel="prefetch" href="/assets/js/56.41585847.js"><link rel="prefetch" href="/assets/js/57.2a10bf1a.js"><link rel="prefetch" href="/assets/js/58.a9b7ff4d.js"><link rel="prefetch" href="/assets/js/59.c5405038.js"><link rel="prefetch" href="/assets/js/6.bcfd2931.js"><link rel="prefetch" href="/assets/js/60.3587de2e.js"><link rel="prefetch" href="/assets/js/61.5631c438.js"><link rel="prefetch" href="/assets/js/62.2b6f5f4a.js"><link rel="prefetch" href="/assets/js/63.9a7cdc8a.js"><link rel="prefetch" href="/assets/js/64.bd0de10d.js"><link rel="prefetch" href="/assets/js/65.0ebb90cc.js"><link rel="prefetch" href="/assets/js/66.97ac1991.js"><link rel="prefetch" href="/assets/js/67.91683dff.js"><link rel="prefetch" href="/assets/js/68.bf757e09.js"><link rel="prefetch" href="/assets/js/69.b5d7f45e.js"><link rel="prefetch" href="/assets/js/7.1855d705.js"><link rel="prefetch" href="/assets/js/70.ec137683.js"><link rel="prefetch" href="/assets/js/71.db01b515.js"><link rel="prefetch" href="/assets/js/72.ecda3334.js"><link rel="prefetch" href="/assets/js/73.e372f374.js"><link rel="prefetch" href="/assets/js/74.56c3c3e8.js"><link rel="prefetch" href="/assets/js/75.a4da3784.js"><link rel="prefetch" href="/assets/js/76.c282fff6.js"><link rel="prefetch" href="/assets/js/77.36cfabde.js"><link rel="prefetch" href="/assets/js/78.d2e36480.js"><link rel="prefetch" href="/assets/js/79.47341e68.js"><link rel="prefetch" href="/assets/js/80.63b64864.js"><link rel="prefetch" href="/assets/js/81.c6335f08.js"><link rel="prefetch" href="/assets/js/82.795fd3e4.js"><link rel="prefetch" href="/assets/js/83.aa17401b.js"><link rel="prefetch" href="/assets/js/84.ca161668.js"><link rel="prefetch" href="/assets/js/85.2bc678f0.js"><link rel="prefetch" href="/assets/js/86.99147b69.js"><link rel="prefetch" href="/assets/js/87.f463e46a.js"><link rel="prefetch" href="/assets/js/88.ce3ac700.js"><link rel="prefetch" href="/assets/js/89.bf88052b.js"><link rel="prefetch" href="/assets/js/90.cd696272.js"><link rel="prefetch" href="/assets/js/91.c701f61a.js"><link rel="prefetch" href="/assets/js/92.39ef4e27.js"><link rel="prefetch" href="/assets/js/93.169f48b8.js"><link rel="prefetch" href="/assets/js/94.0edfaf62.js"><link rel="prefetch" href="/assets/js/95.bc11c1ce.js"><link rel="prefetch" href="/assets/js/96.63e00e6c.js"><link rel="prefetch" href="/assets/js/97.f782fc0f.js"><link rel="prefetch" href="/assets/js/98.f467df64.js"><link rel="prefetch" href="/assets/js/99.7e28dbf5.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.01254cd7.js">
    <link rel="stylesheet" href="/assets/css/0.styles.2b7af6e1.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu have-body-img"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/code.gif" alt="Huidong Blogs" class="logo"> <span class="site-name can-hide">Huidong Blogs</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java基础" class="dropdown-title"><!----> <span class="title" style="display:;">Java基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/javase/" class="nav-link">JavaSE</a></li><li class="dropdown-item"><!----> <a href="/pages/juc/" class="nav-link">并发编程</a></li><li class="dropdown-item"><!----> <a href="/pages/javaweb/" class="nav-link">JavaWeb</a></li><li class="dropdown-item"><!----> <a href="/pages/newversion/" class="nav-link">版本新特性</a></li><li class="dropdown-item"><!----> <a href="/pages/maven/" class="nav-link">开发工具</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><!----> <span class="title" style="display:;">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/spring/" class="nav-link">Spring</a></li><li class="dropdown-item"><!----> <a href="/pages/springmvc/" class="nav-link">SpringMvc</a></li><li class="dropdown-item"><!----> <a href="/pages/mybatis/" class="nav-link">Mybatis</a></li><li class="dropdown-item"><!----> <a href="/pages/springboot/" class="nav-link">SpringBoot</a></li><li class="dropdown-item"><!----> <a href="/pages/springcloud/" class="nav-link">SpringCloud</a></li><li class="dropdown-item"><!----> <a href="/pages/dubbo/" class="nav-link">Dubbo</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="微服务架构" class="dropdown-title"><!----> <span class="title" style="display:;">微服务架构</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/architecture/" class="nav-link">架构演进</a></li><li class="dropdown-item"><!----> <a href="/pages/tx/" class="nav-link">分布式事务</a></li><li class="dropdown-item"><!----> <a href="/pages/designpattern/" class="nav-link">设计模式</a></li><li class="dropdown-item"><!----> <a href="/pages/ddd/" class="nav-link">领域驱动设计</a></li><li class="dropdown-item"><!----> <a href="/pages/89d56d76-7636-3ed6-83c6-310859c07e93/" class="nav-link">分布式锁</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><!----> <span class="title" style="display:;">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/kafka/" class="nav-link">Kafka</a></li><li class="dropdown-item"><!----> <a href="/pages/rocketmq/" class="nav-link">RocketMQ</a></li><li class="dropdown-item"><!----> <a href="/pages/rabbitmq/" class="nav-link">RabbitMQ</a></li><li class="dropdown-item"><!----> <a href="/pages/mysql/" class="nav-link">MySQL</a></li><li class="dropdown-item"><!----> <a href="/pages/redis/" class="nav-link">Redis</a></li><li class="dropdown-item"><!----> <a href="/pages/elasticsearch/" class="nav-link">ElasticSearch</a></li><li class="dropdown-item"><!----> <a href="/pages/zookeeper/" class="nav-link">Zookeeper</a></li><li class="dropdown-item"><!----> <a href="/pages/jvm/" class="nav-link">JVM</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="云计算" class="dropdown-title"><!----> <span class="title" style="display:;">云计算</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/linux/" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/pages/docker/" class="nav-link">Docker</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="大数据" class="dropdown-title"><!----> <span class="title" style="display:;">大数据</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/spark/" class="nav-link">Spark</a></li><li class="dropdown-item"><!----> <a href="/pages/flink/" class="nav-link">Flink</a></li><li class="dropdown-item"><!----> <a href="/pages/hadoop.html" class="nav-link">Hadoop</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><!----> <span class="title" style="display:;">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/html/" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/pages/vue/" class="nav-link">Vue</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="AboutMe" class="dropdown-title"><!----> <span class="title" style="display:;">AboutMe</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/aboutme/" class="nav-link">个人简历</a></li><li class="dropdown-item"><!----> <a href="/pages/a2a9d5e6-b580-3ee0-b2c2-5b1557852fd5/" class="nav-link">项目经验</a></li><li class="dropdown-item"><!----> <a href="/pages/457c4495-1768-3af4-bc65-112ed5748187/" class="nav-link">PPT</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/code.gif"> <div class="blogger-info"><h3>huidong.yin</h3> <span>花花世界迷人眼，没有实力别赛脸。</span></div></div> <nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java基础" class="dropdown-title"><!----> <span class="title" style="display:;">Java基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/javase/" class="nav-link">JavaSE</a></li><li class="dropdown-item"><!----> <a href="/pages/juc/" class="nav-link">并发编程</a></li><li class="dropdown-item"><!----> <a href="/pages/javaweb/" class="nav-link">JavaWeb</a></li><li class="dropdown-item"><!----> <a href="/pages/newversion/" class="nav-link">版本新特性</a></li><li class="dropdown-item"><!----> <a href="/pages/maven/" class="nav-link">开发工具</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><!----> <span class="title" style="display:;">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/spring/" class="nav-link">Spring</a></li><li class="dropdown-item"><!----> <a href="/pages/springmvc/" class="nav-link">SpringMvc</a></li><li class="dropdown-item"><!----> <a href="/pages/mybatis/" class="nav-link">Mybatis</a></li><li class="dropdown-item"><!----> <a href="/pages/springboot/" class="nav-link">SpringBoot</a></li><li class="dropdown-item"><!----> <a href="/pages/springcloud/" class="nav-link">SpringCloud</a></li><li class="dropdown-item"><!----> <a href="/pages/dubbo/" class="nav-link">Dubbo</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="微服务架构" class="dropdown-title"><!----> <span class="title" style="display:;">微服务架构</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/architecture/" class="nav-link">架构演进</a></li><li class="dropdown-item"><!----> <a href="/pages/tx/" class="nav-link">分布式事务</a></li><li class="dropdown-item"><!----> <a href="/pages/designpattern/" class="nav-link">设计模式</a></li><li class="dropdown-item"><!----> <a href="/pages/ddd/" class="nav-link">领域驱动设计</a></li><li class="dropdown-item"><!----> <a href="/pages/89d56d76-7636-3ed6-83c6-310859c07e93/" class="nav-link">分布式锁</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><!----> <span class="title" style="display:;">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/kafka/" class="nav-link">Kafka</a></li><li class="dropdown-item"><!----> <a href="/pages/rocketmq/" class="nav-link">RocketMQ</a></li><li class="dropdown-item"><!----> <a href="/pages/rabbitmq/" class="nav-link">RabbitMQ</a></li><li class="dropdown-item"><!----> <a href="/pages/mysql/" class="nav-link">MySQL</a></li><li class="dropdown-item"><!----> <a href="/pages/redis/" class="nav-link">Redis</a></li><li class="dropdown-item"><!----> <a href="/pages/elasticsearch/" class="nav-link">ElasticSearch</a></li><li class="dropdown-item"><!----> <a href="/pages/zookeeper/" class="nav-link">Zookeeper</a></li><li class="dropdown-item"><!----> <a href="/pages/jvm/" class="nav-link">JVM</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="云计算" class="dropdown-title"><!----> <span class="title" style="display:;">云计算</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/linux/" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/pages/docker/" class="nav-link">Docker</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="大数据" class="dropdown-title"><!----> <span class="title" style="display:;">大数据</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/spark/" class="nav-link">Spark</a></li><li class="dropdown-item"><!----> <a href="/pages/flink/" class="nav-link">Flink</a></li><li class="dropdown-item"><!----> <a href="/pages/hadoop.html" class="nav-link">Hadoop</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><!----> <span class="title" style="display:;">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/html/" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/pages/vue/" class="nav-link">Vue</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="AboutMe" class="dropdown-title"><!----> <span class="title" style="display:;">AboutMe</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/aboutme/" class="nav-link">个人简历</a></li><li class="dropdown-item"><!----> <a href="/pages/a2a9d5e6-b580-3ee0-b2c2-5b1557852fd5/" class="nav-link">项目经验</a></li><li class="dropdown-item"><!----> <a href="/pages/457c4495-1768-3af4-bc65-112ed5748187/" class="nav-link">PPT</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Kafka</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>RocketMQ</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/rocketmq/" class="sidebar-link">RocketMQ安装部署</a></li><li><a href="/pages/63be4d2b-1721-3ec9-91de-0de76f19ef20/" aria-current="page" class="active sidebar-link">RocketMQ基础入门</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/63be4d2b-1721-3ec9-91de-0de76f19ef20/#_1-同步发送-异步发送-单向发送" class="sidebar-link">1.同步发送，异步发送，单向发送</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/63be4d2b-1721-3ec9-91de-0de76f19ef20/#_1-生产者" class="sidebar-link">1) 生产者</a></li><li class="sidebar-sub-header level3"><a href="/pages/63be4d2b-1721-3ec9-91de-0de76f19ef20/#_2-消费者" class="sidebar-link">2)消费者</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/63be4d2b-1721-3ec9-91de-0de76f19ef20/#_2-顺序消息" class="sidebar-link">2.顺序消息</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/63be4d2b-1721-3ec9-91de-0de76f19ef20/#_1-什么是顺序消息" class="sidebar-link">1)什么是顺序消息</a></li><li class="sidebar-sub-header level3"><a href="/pages/63be4d2b-1721-3ec9-91de-0de76f19ef20/#_2-底层逻辑" class="sidebar-link">2)底层逻辑</a></li><li class="sidebar-sub-header level3"><a href="/pages/63be4d2b-1721-3ec9-91de-0de76f19ef20/#_3-全局顺序消息" class="sidebar-link">3)全局顺序消息</a></li><li class="sidebar-sub-header level3"><a href="/pages/63be4d2b-1721-3ec9-91de-0de76f19ef20/#_4-局部顺序消息" class="sidebar-link">4)局部顺序消息</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/63be4d2b-1721-3ec9-91de-0de76f19ef20/#_3-批量消息" class="sidebar-link">3.批量消息</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/63be4d2b-1721-3ec9-91de-0de76f19ef20/#_1-批量发送消息" class="sidebar-link">1)批量发送消息</a></li><li class="sidebar-sub-header level3"><a href="/pages/63be4d2b-1721-3ec9-91de-0de76f19ef20/#_2-批量消费消息" class="sidebar-link">2)批量消费消息</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/63be4d2b-1721-3ec9-91de-0de76f19ef20/#_4-广播消息" class="sidebar-link">4.广播消息</a></li><li class="sidebar-sub-header level2"><a href="/pages/63be4d2b-1721-3ec9-91de-0de76f19ef20/#_5-延时消息" class="sidebar-link">5.延时消息</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/63be4d2b-1721-3ec9-91de-0de76f19ef20/#_1-什么是延时消息" class="sidebar-link">1)什么是延时消息</a></li><li class="sidebar-sub-header level3"><a href="/pages/63be4d2b-1721-3ec9-91de-0de76f19ef20/#_2-延时消息等级" class="sidebar-link">2)延时消息等级</a></li><li class="sidebar-sub-header level3"><a href="/pages/63be4d2b-1721-3ec9-91de-0de76f19ef20/#_3-延时消息使用示例" class="sidebar-link">3)延时消息使用示例</a></li><li class="sidebar-sub-header level3"><a href="/pages/63be4d2b-1721-3ec9-91de-0de76f19ef20/#_4-延迟消息实现原理" class="sidebar-link">4)延迟消息实现原理</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/63be4d2b-1721-3ec9-91de-0de76f19ef20/#_6-过滤消息" class="sidebar-link">6.过滤消息</a></li><li class="sidebar-sub-header level2"><a href="/pages/63be4d2b-1721-3ec9-91de-0de76f19ef20/#_7-事务消息" class="sidebar-link">7.事务消息</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/63be4d2b-1721-3ec9-91de-0de76f19ef20/#_1-应用场景" class="sidebar-link">1)应用场景</a></li><li class="sidebar-sub-header level3"><a href="/pages/63be4d2b-1721-3ec9-91de-0de76f19ef20/#_2-使用案例" class="sidebar-link">2)使用案例</a></li><li class="sidebar-sub-header level3"><a href="/pages/63be4d2b-1721-3ec9-91de-0de76f19ef20/#_3-原理介绍" class="sidebar-link">3)原理介绍</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/63be4d2b-1721-3ec9-91de-0de76f19ef20/#_8-权限控制" class="sidebar-link">8.权限控制</a></li></ul></li><li><a href="/pages/0d520535-8bff-3ea6-aabe-bc4ff4008127/" class="sidebar-link">RocketMQ源码环境搭建</a></li><li><a href="/pages/eba85197-e655-32cf-acc3-13b5fa2f8c26/" class="sidebar-link">RocketMQ架构设计</a></li><li><a href="/pages/36037548-8e70-3d58-846d-7420e6c3d0c7/" class="sidebar-link">RocketMQ网络层源码分析</a></li><li><a href="/pages/91d2371c-3534-337f-b8ab-926068b02aea/" class="sidebar-link">RocketMQ路由中心源码分析</a></li><li><a href="/pages/35f53959-d2e6-3a4b-baec-9e43158f1925/" class="sidebar-link">RocketMQ消息发送源码分析</a></li><li><a href="/pages/af733c7e-a29d-3a2d-b926-8596fc89f3fa/" class="sidebar-link">RocketMQ消息存储源码分析</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>RabbitMQ</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>MySQL</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Redis</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ElasticSearch</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Zookeeper</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Netty</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Tomcat</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JVM</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/categories/?category=%E4%B8%AD%E9%97%B4%E4%BB%B6" title="分类" data-v-06225672>中间件</a></li><li data-v-06225672><a href="/categories/?category=RocketMQ" title="分类" data-v-06225672>RocketMQ</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://huidongyin.github.io" target="_blank" title="作者" class="beLink" data-v-06225672>huidong.yin</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2023-01-01</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">RocketMQ基础入门<!----></h1>  <div class="theme-vdoing-content content__default"><blockquote><p><code>springboot</code>整合<code>RocketMQ</code>的<code>starter</code>依赖包是<code>Spring</code>官方维护的，更新的很快，每个版本都不一样，从稳定性来讲，通过<code>SpringBoot</code>去整合<code>RocketMQ</code>的<code>sdk</code>更合适。</p></blockquote> <hr> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.rocketmq<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>rocketmq-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.8.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">rocketmq.producer.group</span><span class="token punctuation">=</span><span class="token value attr-value">boot_rocketmq_producer</span>
<span class="token key attr-name">rocketmq.namesrv.addr</span><span class="token punctuation">=</span><span class="token value attr-value">127.0.0.1:9876</span>
<span class="token key attr-name">rocketmq.topic.name</span><span class="token punctuation">=</span><span class="token value attr-value">boot_rocketmq_topic</span>
<span class="token key attr-name">rocketmq.consumer.group</span><span class="token punctuation">=</span><span class="token value attr-value">boot_rocketmq_consumer</span>
<span class="token key attr-name">rocketmq.producer.max.message.size</span><span class="token punctuation">=</span><span class="token value attr-value">10</span>
<span class="token key attr-name">rocketmq.transaction.producer.group</span><span class="token punctuation">=</span><span class="token value attr-value">boot_rocketmq_producer_tx</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><hr> <h2 id="_1-同步发送-异步发送-单向发送"><a href="#_1-同步发送-异步发送-单向发送" class="header-anchor">#</a> 1.同步发送，异步发送，单向发送</h2> <h3 id="_1-生产者"><a href="#_1-生产者" class="header-anchor">#</a> 1) 生产者</h3> <ol><li>同步发送生产者会等待<code>broker</code>回应后才能继续发送下一条消息。</li> <li>异步发送是指发送方发出数据后，不等接收方发回响应，接着发送下个数据包的通讯方式。 <code>MQ</code> 的异步发送，需要用户实现异步发送回调（<code>SendCallback</code>）。消息发送方在发送了一条消息后，不需要等待服务器响应即可返回，进行第二条消息发送。发送方通过回调接口接收服务器响应，并对响应结果进行处理。</li> <li>单向（<code>Oneway</code>）发送特点为发送方只负责发送消息，不等待服务器回应且没有回调函数触发，即只发送请求不等待应答，效率最高，通常用于一些消息不是很重要的场景。</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">InitializingBean</span><span class="token punctuation">,</span> <span class="token class-name">DisposableBean</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${rocketmq.producer.group}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> rocketmqGroupName<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${rocketmq.namesrv.addr}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> rocketmqNamesrvAddr<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${rocketmq.topic.name}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> rocketmqTopicName<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${rocketmq.producer.max.message.size}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> maxMessageSize<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">DefaultMQProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        producer<span class="token punctuation">.</span><span class="token function">setProducerGroup</span><span class="token punctuation">(</span>rocketmqGroupName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span>rocketmqNamesrvAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">setMaxMessageSize</span><span class="token punctuation">(</span>maxMessageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendAsync</span><span class="token punctuation">(</span><span class="token class-name">T</span> message<span class="token punctuation">,</span> <span class="token class-name">SendCallback</span> sendCallback<span class="token punctuation">,</span> <span class="token class-name">String</span> tags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Message</span> rocketmqMessage <span class="token operator">=</span> <span class="token function">buildRocketMqMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> tags<span class="token punctuation">)</span><span class="token punctuation">;</span>
            producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>rocketmqMessage<span class="token punctuation">,</span> sendCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;send message error ,error message is {}&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token class-name">SendResult</span> <span class="token function">sendSync</span><span class="token punctuation">(</span><span class="token class-name">T</span> message<span class="token punctuation">,</span> <span class="token class-name">String</span> tags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Message</span> rocketmqMessage <span class="token operator">=</span> <span class="token function">buildRocketMqMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> tags<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>rocketmqMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;send message error ,error message is {}&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendOneWay</span><span class="token punctuation">(</span><span class="token class-name">T</span> message<span class="token punctuation">,</span> <span class="token class-name">String</span> tags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Message</span> rocketmqMessage <span class="token operator">=</span> <span class="token function">buildRocketMqMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> tags<span class="token punctuation">)</span><span class="token punctuation">;</span>
            producer<span class="token punctuation">.</span><span class="token function">sendOneway</span><span class="token punctuation">(</span>rocketmqMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;send message error ,error message is {}&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">Message</span> <span class="token function">buildRocketMqMessage</span><span class="token punctuation">(</span><span class="token class-name">T</span> message<span class="token punctuation">,</span> <span class="token class-name">String</span> tags<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UnsupportedEncodingException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Message</span> rocketmqMessage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rocketmqMessage<span class="token punctuation">.</span><span class="token function">setBody</span><span class="token punctuation">(</span><span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">RemotingHelper</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_CHARSET</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rocketmqMessage<span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span>rocketmqTopicName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        rocketmqMessage<span class="token punctuation">.</span><span class="token function">setTags</span><span class="token punctuation">(</span>tags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> rocketmqMessage<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br></div></div><hr> <h3 id="_2-消费者"><a href="#_2-消费者" class="header-anchor">#</a> 2)消费者</h3> <p>消费者消费消息有两种模式:<code>push</code>，<code>pull</code>。通常情况下用<code>push</code>更为简单，<code>push</code>模式也是<code>pull</code>模式封装的。从<code>4.7.1</code>版本开始，<code>DefaultMQPullConsumerImpl</code>这个消费者类被标记为过期的类，但是还是可以使用的，替换的类是<code>DefaultLitePullConsumerImpl</code>。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IConsumer</span> <span class="token keyword">implements</span> <span class="token class-name">InitializingBean</span><span class="token punctuation">,</span> <span class="token class-name">DisposableBean</span> <span class="token punctuation">{</span>


    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${rocketmq.consumer.group}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> rocketmqConsumerGroup<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${rocketmq.namesrv.addr}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> rocketmqNamesrvAddr<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${rocketmq.topic.name}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> rocketmqTopicName<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;rocketmq.consumer.group.tags&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> tags<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">DefaultMQPushConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">&gt;</span></span> msgs<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        consumer<span class="token punctuation">.</span><span class="token function">setConsumerGroup</span><span class="token punctuation">(</span>rocketmqConsumerGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span>rocketmqNamesrvAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">setConsumeFromWhere</span><span class="token punctuation">(</span><span class="token class-name">ConsumeFromWhere</span><span class="token punctuation">.</span><span class="token constant">CONSUME_FROM_FIRST_OFFSET</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">setConsumeTimestamp</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定每次可以消费10条消息，默认为1</span>
        consumer<span class="token punctuation">.</span><span class="token function">setConsumeMessageBatchMaxSize</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定每次可以从Broker拉取40条消息，默认为32</span>
        consumer<span class="token punctuation">.</span><span class="token function">setPullBatchSize</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token function">registerListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>rocketmqTopicName<span class="token punctuation">,</span>tags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//filter message by sql .</span>
        <span class="token comment">// Don't forget to set enablePropertyFilter=true in broker</span>
        <span class="token comment">//consumer.subscribe(rocketmqTopicName,MessageSelector.bySql(&quot;(TAGS is not null and TAGS in ('TagA', 'TagB'))&quot; +&quot;and (a is not null and a between 0 and 3)&quot;));</span>
        consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">MessageListenerConcurrently</span> <span class="token function">registerListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>msgs<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">//这里其实就是业务的处理逻辑</span>
            <span class="token function">set</span><span class="token punctuation">(</span>msgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span><span class="token constant">CONSUME_SUCCESS</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">&gt;</span></span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>msgs<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgs<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">&gt;</span></span> msgs<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>msgs<span class="token operator">=</span>msgs<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        consumer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br></div></div><hr> <h2 id="_2-顺序消息"><a href="#_2-顺序消息" class="header-anchor">#</a> 2.顺序消息</h2> <h3 id="_1-什么是顺序消息"><a href="#_1-什么是顺序消息" class="header-anchor">#</a> 1)什么是顺序消息</h3> <p>消息有序指的是消费者消费消息的时候，需要按照消息的发送顺序来消费，即先发送的消息，需要先消费【<code>FIFO</code>】。
<code>RocketMQ</code>采用了局部顺序一致性的机制，实现了单个队列中消息的有序性，使用<code>FIFO</code>顺序提供有序消息。底层逻辑其实就是为了保证消息的有序性，把一组消息存放在同一个队列，然后通过消费者进行逐一消费。
但是如果碰到高并发，消息不就会阻塞了嘛？
<code>RocketMQ</code>给出的解决方案是按照业务去划分不同的队列，然后并行消费，提高消息处理速度的同时避免消息堆积。
<code>RocketMQ</code>可以严格的保证消息的顺序，可以分为分区有序和全局有序。</p> <ol><li>分区有序：多<code>queue</code>并行消费。</li> <li>全局有序：单<code>queue</code>消费。</li></ol> <hr> <h3 id="_2-底层逻辑"><a href="#_2-底层逻辑" class="header-anchor">#</a> 2)底层逻辑</h3> <p>在默认的情况下，消息发送会采取<code>Round Robin</code>轮询方式把消息发送到不同的<code>queue</code>；而消费消息的时候从多个<code>queue</code>上拉取消息，这种情况发送和消费是不能保证顺序的。但是如果控制发送的顺序消息只依次发送到同一个<code>queue</code>中，消费的时候只从这个<code>queue</code>上依次拉取，则就保证了顺序。当发送和消费参与的<code>queue</code>只有一个，则是全局有序；如果多个<code>queue</code>参与，则为分区有序，即相对每个<code>queue</code>，消息都是有序的。</p> <hr> <h3 id="_3-全局顺序消息"><a href="#_3-全局顺序消息" class="header-anchor">#</a> 3)全局顺序消息</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">InitializingBean</span><span class="token punctuation">,</span> <span class="token class-name">DisposableBean</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${rocketmq.producer.group}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> rocketmqGroupName<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${rocketmq.namesrv.addr}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> rocketmqNamesrvAddr<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${rocketmq.topic.name}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> rocketmqTopicName<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${rocketmq.producer.max.message.size}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> maxMessageSize<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">DefaultMQProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        producer<span class="token punctuation">.</span><span class="token function">setProducerGroup</span><span class="token punctuation">(</span>rocketmqGroupName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span>rocketmqNamesrvAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">setMaxMessageSize</span><span class="token punctuation">(</span>maxMessageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">private</span> <span class="token class-name">Message</span> <span class="token function">buildRocketMqMessage</span><span class="token punctuation">(</span><span class="token class-name">T</span> message<span class="token punctuation">,</span> <span class="token class-name">String</span> tags<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UnsupportedEncodingException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Message</span> rocketmqMessage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rocketmqMessage<span class="token punctuation">.</span><span class="token function">setBody</span><span class="token punctuation">(</span><span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">RemotingHelper</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_CHARSET</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rocketmqMessage<span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span>rocketmqTopicName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        rocketmqMessage<span class="token punctuation">.</span><span class="token function">setTags</span><span class="token punctuation">(</span>tags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> rocketmqMessage<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     *
     * @param messageList 需要发送的消息(可以为一个也可以为多个)
     * @param tags 消息的二级分类
     * @param index 消息将要进入的队列下标
     * @param sendCallback 发送成功或者失败的回调
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendOrder</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> messageList<span class="token punctuation">,</span> <span class="token class-name">String</span> tags<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token comment">/*消息将要进入队列的下标*/</span><span class="token punctuation">,</span> <span class="token class-name">SendCallback</span> sendCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">T</span> t <span class="token operator">:</span> messageList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Message</span> message <span class="token operator">=</span> <span class="token function">buildRocketMqMessage</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tags<span class="token punctuation">)</span><span class="token punctuation">;</span>
                producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token function">getSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span> sendCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;send message error ,error message is {}&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">private</span> <span class="token class-name">MessageQueueSelector</span> <span class="token function">getSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/*
         * @param mqs 该topic下所有的队列集合
         * @param msg 发送的消息
         * @param arg 消息将要进入队列的下标
         */</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>mqs<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> arg<span class="token comment">/*消息将要进入队列的下标*/</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> mqs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br></div></div><hr> <p>消费端和常规的消费唯一区别是注册的消息监听器不同。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token function">registerListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token class-name">MessageListenerOrderly</span> <span class="token function">registerListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>msgs<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            context<span class="token punctuation">.</span><span class="token function">setAutoCommit</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">set</span><span class="token punctuation">(</span>msgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">ConsumeOrderlyStatus</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><hr> <h3 id="_4-局部顺序消息"><a href="#_4-局部顺序消息" class="header-anchor">#</a> 4)局部顺序消息</h3> <p>下面用订单进行分区有序的示例。一个订单创建完成后，订单的状态流转大概是：【订单创建 -&gt; 订单支付 -&gt; 订单完成】，我们在创建<code>MessageQueueSelector</code>消息队列选择器的时候，需要根据业务唯一标识自定义队列选择算法，如本例中则可以使用<code>orderId</code>订单号去选择队列。这样的话，订单号相同的消息会被先后发送到同一个队列中，消费时，同一个<code>OrderId</code>获取到的肯定是同一个队列。
<img src="https://raw.githubusercontent.com/huidongyin/DrawingBed/main/RocketMQ/202311052139747.png" alt="image.png"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderMQProducer</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MQClientException</span><span class="token punctuation">,</span> <span class="token class-name">UnsupportedEncodingException</span><span class="token punctuation">,</span> <span class="token class-name">RemotingException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">MQBrokerException</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 创建DefaultMQProducer类并设定生产者名称</span>
        <span class="token class-name">DefaultMQProducer</span> mqProducer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">&quot;producer-group-test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置NameServer地址，如果是集群的话，使用分号;分隔开</span>
        mqProducer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">&quot;10.0.90.86:9876&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 启动消息生产者</span>
        mqProducer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> orderList <span class="token operator">=</span> <span class="token function">getOrderList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> orderList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> body <span class="token operator">=</span> <span class="token string">&quot;【&quot;</span> <span class="token operator">+</span> orderList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;】订单状态变更消息&quot;</span><span class="token punctuation">;</span>
            <span class="token comment">// 创建消息，并指定Topic(主题)，Tag(标签)和消息内容</span>
            <span class="token class-name">Message</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token string">&quot;ORDER_STATUS_CHANGE&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> body<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">RemotingHelper</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_CHARSET</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
            <span class="token comment">// MessageQueueSelector: 消息队列选择器，根据业务唯一标识自定义队列选择算法</span>
            <span class="token comment">/**
             * msg：消息对象
             * selector：消息队列的选择器
             * arg：选择队列的业务标识,如本例中的orderId
             */</span>
            <span class="token class-name">SendResult</span> sendResult <span class="token operator">=</span> mqProducer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MessageQueueSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 
                <span class="token comment">/**
                 * @param mqs 队列集合
                 * @param msg 消息对象
                 * @param arg 业务标识的参数，对应send()方法传入的第三个参数arg
                 * @return
                 */</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token class-name">MessageQueue</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> mqs<span class="token punctuation">,</span> <span class="token class-name">Message</span> msg<span class="token punctuation">,</span> <span class="token class-name">Object</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//根据arg(实际上是订单id)选择消息发送的队列</span>
                    <span class="token keyword">long</span> index <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">)</span> arg <span class="token operator">%</span> mqs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> mqs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//mqProducer.send()方法第三个参数, 会传递到select()方法的arg参数</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> orderList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;消息发送状态:%s, orderId:%s, queueId:%d, body:%s&quot;</span><span class="token punctuation">,</span>
                    sendResult<span class="token punctuation">.</span><span class="token function">getSendStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    orderList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    sendResult<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    body<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果不再发送消息，关闭Producer实例</span>
        mqProducer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">/**
     * 订单状态变更流程: ORDER_CREATE(订单创建) -&gt; ORDER_PAYED(订单已支付) -&gt; ORDER_COMPLETE(订单完成)
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> <span class="token function">getOrderList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> orderList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Order</span> orderDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderStatus</span><span class="token punctuation">(</span><span class="token string">&quot;ORDER_CREATE&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        orderDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span><span class="token number">2L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderStatus</span><span class="token punctuation">(</span><span class="token string">&quot;ORDER_CREATE&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        orderDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderStatus</span><span class="token punctuation">(</span><span class="token string">&quot;ORDER_PAYED&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        orderDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span><span class="token number">2L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderStatus</span><span class="token punctuation">(</span><span class="token string">&quot;ORDER_PAYED&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        orderDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span><span class="token number">2L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderStatus</span><span class="token punctuation">(</span><span class="token string">&quot;ORDER_COMPLETE&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        orderDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span><span class="token number">3L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderStatus</span><span class="token punctuation">(</span><span class="token string">&quot;ORDER_CREATE&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        orderDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span><span class="token number">4L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderStatus</span><span class="token punctuation">(</span><span class="token string">&quot;ORDER_CREATE&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        orderDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span><span class="token number">3L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderStatus</span><span class="token punctuation">(</span><span class="token string">&quot;ORDER_PAYED&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        orderDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderStatus</span><span class="token punctuation">(</span><span class="token string">&quot;ORDER_COMPLETE&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        orderDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span><span class="token number">3L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderStatus</span><span class="token punctuation">(</span><span class="token string">&quot;ORDER_COMPLETE&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        orderDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span><span class="token number">4L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderStatus</span><span class="token punctuation">(</span><span class="token string">&quot;ORDER_PAYED&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        orderDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span><span class="token number">4L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderDemo<span class="token punctuation">.</span><span class="token function">setOrderStatus</span><span class="token punctuation">(</span><span class="token string">&quot;ORDER_COMPLETE&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token keyword">return</span> orderList<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
<span class="token punctuation">}</span>
 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Order</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
 
    <span class="token comment">/**
     * 订单ID
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> orderId<span class="token punctuation">;</span>
 
    <span class="token comment">/**
     * 订单状态
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> orderStatus<span class="token punctuation">;</span>
 
    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> orderId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setOrderId</span><span class="token punctuation">(</span><span class="token class-name">Long</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>orderId <span class="token operator">=</span> orderId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getOrderStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> orderStatus<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setOrderStatus</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderStatus<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>orderStatus <span class="token operator">=</span> orderStatus<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;Order{&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;orderId=&quot;</span> <span class="token operator">+</span> orderId <span class="token operator">+</span>
                <span class="token string">&quot;, orderStatus='&quot;</span> <span class="token operator">+</span> orderStatus <span class="token operator">+</span> <span class="token char">'\''</span> <span class="token operator">+</span>
                <span class="token char">'}'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IOrderConsumer</span> <span class="token keyword">implements</span> <span class="token class-name">InitializingBean</span><span class="token punctuation">,</span> <span class="token class-name">DisposableBean</span> <span class="token punctuation">{</span>


    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${rocketmq.consumer.group}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> rocketmqConsumerGroup<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${rocketmq.namesrv.addr}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> rocketmqNamesrvAddr<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${rocketmq.topic.name}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> rocketmqTopicName<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;rocketmq.consumer.group.tags&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> tags<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">DefaultMQPushConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">&gt;</span></span> msgs<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        consumer<span class="token punctuation">.</span><span class="token function">setConsumerGroup</span><span class="token punctuation">(</span>rocketmqConsumerGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span>rocketmqNamesrvAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">setConsumeFromWhere</span><span class="token punctuation">(</span><span class="token class-name">ConsumeFromWhere</span><span class="token punctuation">.</span><span class="token constant">CONSUME_FROM_FIRST_OFFSET</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">setConsumeTimestamp</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token function">registerListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>rocketmqTopicName<span class="token punctuation">,</span>tags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 注册回调实现类来处理从broker拉取回来的消息</span>
    <span class="token comment">// 注意：顺序消息注册的是MessageListenerOrderly监听器</span>
    <span class="token keyword">private</span> <span class="token class-name">MessageListenerOrderly</span> <span class="token function">registerListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MessageExt</span> msg <span class="token operator">:</span> msgList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 每个queue有唯一的consume线程来消费, 订单对每个queue都是分区有序</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;消费线程=&quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                    <span class="token string">&quot;, queueId=&quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, 消息内容:&quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 标记该消息已经被成功消费</span>
        <span class="token keyword">return</span> <span class="token class-name">ConsumeOrderlyStatus</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">&gt;</span></span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>msgs<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgs<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">&gt;</span></span> msgs<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>msgs<span class="token operator">=</span>msgs<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        consumer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br></div></div><p>顺序消息存在的问题：</p> <ol><li>消费顺序的并行度依赖于队列数量</li> <li>个别队列由于<code>hash</code>分布不均匀，导致消息过多</li> <li>遇到消费失败的消息，无法跳过，当前队列消费暂停</li></ol> <hr> <h2 id="_3-批量消息"><a href="#_3-批量消息" class="header-anchor">#</a> 3.批量消息</h2> <h3 id="_1-批量发送消息"><a href="#_1-批量发送消息" class="header-anchor">#</a> 1)批量发送消息</h3> <p><strong>发送限制</strong></p> <ol><li>批量发送的消息必须具有相同的<code>topic</code></li> <li>批量发送的消息必须具有相同的刷盘策略</li> <li>批量发送的消息不能是延时消息和事务消息</li></ol> <p><strong>批量发送大小</strong>
默认情况下，一批发送消息的总大小不超过<code>4MB</code>，如果想超出这个值，有两种办法。</p> <ol><li>将批量消息进行拆分，拆分为若干不大于<code>4MB</code>的消息集合分多批发送。</li> <li>在生产者端和<code>Broker</code>端修改配置属性。</li></ol> <blockquote><p>生产者端需要在发送之前设置<code>maxMessageSize</code>属性
<code>Broker</code>端需要修改<code>broker.conf</code>文件的<code>maxMessageSize</code>属性</p></blockquote> <p><strong>生产者发送的消息大小</strong> <img src="https://raw.githubusercontent.com/huidongyin/DrawingBed/main/RocketMQ/202311052139892.png" alt="image.png">
生产者通过<code>send()</code>方法发送的<code>Message</code>，并不是直接将<code>Message</code>序列化后发送到网络上的，而是通过这个<code>Message</code>生成了一个字符串发送出去的。这个字符串由四部分构成：<code>Topic</code>、消息<code>Body</code>、消息日志（占20字节），及用于描述消息的一堆属性<code>key-value</code>。这些属性中包含例如生产者地址、生产时间、要发送的<code>QueueId</code>等。最终写入到<code>Broker</code>中消息单元中的数据都是来自于这些属性。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">InitializingBean</span><span class="token punctuation">,</span> <span class="token class-name">DisposableBean</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${rocketmq.producer.group}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> rocketmqGroupName<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${rocketmq.namesrv.addr}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> rocketmqNamesrvAddr<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${rocketmq.topic.name}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> rocketmqTopicName<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${rocketmq.producer.max.message.size}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> maxMessageSize<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">DefaultMQProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        producer<span class="token punctuation">.</span><span class="token function">setProducerGroup</span><span class="token punctuation">(</span>rocketmqGroupName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span>rocketmqNamesrvAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">setMaxMessageSize</span><span class="token punctuation">(</span>maxMessageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendBatchNormal</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> messages<span class="token punctuation">,</span> <span class="token class-name">SendCallback</span> sendCallback<span class="token punctuation">,</span> <span class="token class-name">String</span> tags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">T</span> message <span class="token operator">:</span> messages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Message</span> rocketmqMessage <span class="token operator">=</span> <span class="token function">buildRocketMqMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> tags<span class="token punctuation">)</span><span class="token punctuation">;</span>
                producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>rocketmqMessage<span class="token punctuation">,</span> sendCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;send message error ,error message is {}&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendBatchSplit</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> messages<span class="token punctuation">,</span> <span class="token class-name">SendCallback</span> sendCallback<span class="token punctuation">,</span> <span class="token class-name">String</span> tags<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Message</span><span class="token punctuation">&gt;</span></span> messageList <span class="token operator">=</span> messages<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>a <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token function">buildRocketMqMessage</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> tags<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UnsupportedEncodingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;build message error ,error message is {}&quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ListSplitter</span> splitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ListSplitter</span><span class="token punctuation">(</span>messageList<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>splitter<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Message</span><span class="token punctuation">&gt;</span></span> listItem <span class="token operator">=</span> splitter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>listItem<span class="token punctuation">,</span>sendCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;send message error ,error message is {}&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>




    <span class="token keyword">private</span> <span class="token class-name">Message</span> <span class="token function">buildRocketMqMessage</span><span class="token punctuation">(</span><span class="token class-name">T</span> message<span class="token punctuation">,</span> <span class="token class-name">String</span> tags<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UnsupportedEncodingException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Message</span> rocketmqMessage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rocketmqMessage<span class="token punctuation">.</span><span class="token function">setBody</span><span class="token punctuation">(</span><span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">RemotingHelper</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_CHARSET</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rocketmqMessage<span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span>rocketmqTopicName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        rocketmqMessage<span class="token punctuation">.</span><span class="token function">setTags</span><span class="token punctuation">(</span>tags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> rocketmqMessage<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ListSplitter</span> <span class="token keyword">implements</span> <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Message</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> sizeLimit <span class="token operator">=</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Message</span><span class="token punctuation">&gt;</span></span> messages<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> currIndex<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">ListSplitter</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Message</span><span class="token punctuation">&gt;</span></span> messages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>messages <span class="token operator">=</span> messages<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> currIndex <span class="token operator">&lt;</span> messages<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Message</span><span class="token punctuation">&gt;</span></span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> nextIndex <span class="token operator">=</span> currIndex<span class="token punctuation">;</span>
            <span class="token keyword">int</span> totalSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> nextIndex <span class="token operator">&lt;</span> messages<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> nextIndex<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Message</span> message <span class="token operator">=</span> messages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>nextIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> tmpSize <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
                <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> properties <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> properties<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    tmpSize <span class="token operator">+=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                tmpSize <span class="token operator">=</span> tmpSize <span class="token operator">+</span> <span class="token number">20</span><span class="token punctuation">;</span> <span class="token comment">//for log overhead</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>tmpSize <span class="token operator">&gt;</span> sizeLimit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//it is unexpected that single message exceeds the sizeLimit</span>
                    <span class="token comment">//here just let it go, otherwise it will block the splitting process</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextIndex <span class="token operator">-</span> currIndex <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">//if the next sublist has no element, add this one and then break, otherwise just break</span>
                        nextIndex<span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>tmpSize <span class="token operator">+</span> totalSize <span class="token operator">&gt;</span> sizeLimit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    totalSize <span class="token operator">+=</span> tmpSize<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

            <span class="token punctuation">}</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Message</span><span class="token punctuation">&gt;</span></span> subList <span class="token operator">=</span> messages<span class="token punctuation">.</span><span class="token function">subList</span><span class="token punctuation">(</span>currIndex<span class="token punctuation">,</span> nextIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            currIndex <span class="token operator">=</span> nextIndex<span class="token punctuation">;</span>
            <span class="token keyword">return</span> subList<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token string">&quot;Not allowed to remove&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br></div></div><hr> <h3 id="_2-批量消费消息"><a href="#_2-批量消费消息" class="header-anchor">#</a> 2)批量消费消息</h3> <p><strong>修改批量属性</strong> <code>Consumer</code>的<code>MessageListenerConcurrently</code>监听接口的<code>consumeMessage()</code>方法的第一个参数为消息列表，但默认情况下每次只能消费一条消息。若要使其一次可以消费多条消息，则可以通过修改<code>Consumer</code>的<code>consumeMessageBatchMaxSize</code>属性来指定。不过，该值不能超过32。因为默认情况下消费者每次可以拉取的消息最多是32条。若要修改一次拉取的最大值，则可通过修改<code>Consumer</code>的<code>pullBatchSize</code>属性来指定。
<strong>痛点</strong> <code>Consumer</code>的<code>pullBatchSize</code>属性与<code>consumeMessageBatchMaxSize</code>属性是否设置的越大越好？当然不是。</p> <ul><li><code>pullBatchSize</code>值设置的越大，<code>Consumer</code>每拉取一次需要的时间就会越长，且在网络上传输出现问题的可能性就越高。若在拉取过程中若出现了问题，那么本批次所有消息都需要全部重新拉取。</li> <li><code>consumeMessageBatchMaxSize</code>值设置的越大，<code>Consumer</code>的消息并发消费能力越低，且这批被消费的消息具有相同的消费结果。因为<code>consumeMessageBatchMaxSize</code>指定的一批消息只会使用一个线程进行处理，且在处理过程中只要有一个消息处理异常，则这批消息需要全部重新再次消费处理。</li></ul> <hr> <h2 id="_4-广播消息"><a href="#_4-广播消息" class="header-anchor">#</a> 4.广播消息</h2> <p><code>RocketMQ</code>消息模式主要有两种：</p> <ol><li><code>MessageMode.CLUSTERING</code>:集群模式。同一消费组内的每个消费者，只消费到<code>Topic</code>内的一部分消息，所有消费者消费的消息加起来就是<code>Topic</code>的所有消息。</li> <li><code>MessageMode.BROADCASTING</code>:广播模式。同一消费组内的每个消费者，都消费到<code>Topic</code>的所有消息。如<code>Topic</code>有100条消息，则同一个消费者组下的所有消费者都能消费到100条消息。</li></ol> <p>消息广播主要配置在于消费者通过配置消息模式实现。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IBroadCastingConsumer</span> <span class="token keyword">implements</span> <span class="token class-name">InitializingBean</span><span class="token punctuation">,</span> <span class="token class-name">DisposableBean</span> <span class="token punctuation">{</span>


    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${rocketmq.consumer.group}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> rocketmqConsumerGroup<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${rocketmq.namesrv.addr}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> rocketmqNamesrvAddr<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${rocketmq.topic.name}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> rocketmqTopicName<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;rocketmq.consumer.group.tags&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> tags<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">DefaultMQPushConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">&gt;</span></span> msgs<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        consumer<span class="token punctuation">.</span><span class="token function">setConsumerGroup</span><span class="token punctuation">(</span>rocketmqConsumerGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span>rocketmqNamesrvAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">setConsumeFromWhere</span><span class="token punctuation">(</span><span class="token class-name">ConsumeFromWhere</span><span class="token punctuation">.</span><span class="token constant">CONSUME_FROM_FIRST_OFFSET</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">setMessageModel</span><span class="token punctuation">(</span><span class="token class-name">MessageModel</span><span class="token punctuation">.</span><span class="token constant">BROADCASTING</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">setConsumeTimestamp</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token function">registerListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>rocketmqTopicName<span class="token punctuation">,</span>tags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">MessageListenerConcurrently</span> <span class="token function">registerListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>msgs<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">set</span><span class="token punctuation">(</span>msgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span><span class="token constant">CONSUME_SUCCESS</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">&gt;</span></span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>msgs<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgs<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">&gt;</span></span> msgs<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>msgs<span class="token operator">=</span>msgs<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        consumer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><hr> <h2 id="_5-延时消息"><a href="#_5-延时消息" class="header-anchor">#</a> 5.延时消息</h2> <h3 id="_1-什么是延时消息"><a href="#_1-什么是延时消息" class="header-anchor">#</a> 1)什么是延时消息</h3> <p>当消息写到<code>broker</code>后，不能立刻被消费者消费，需要等待指定的时长后才可以被消费处理的消息，称为延时消息。</p> <hr> <h3 id="_2-延时消息等级"><a href="#_2-延时消息等级" class="header-anchor">#</a> 2)延时消息等级</h3> <p><code>RocketMQ</code>延时消息的延迟时长不支持随意时长的延时，是通过特定的延迟等级来指定的。默认支持18个等级的延迟消息，延时等级定义在<code>RocketMQ</code>服务端的<code>MessageStoreConfig</code>类中。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// MessageStoreConfig.java</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> messageDelayLevel <span class="token operator">=</span> <span class="token string">&quot;1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h&quot;</span><span class="token punctuation">;</span>
 
<span class="token comment">//发消息时，设置delayLevel等级即可：msg.setDelayLevel(level)。level有以下三种情况：</span>
level <span class="token operator">==</span> <span class="token number">0</span>，消息为非延迟消息
<span class="token number">1</span><span class="token operator">&lt;=</span>level<span class="token operator">&lt;=</span>maxLevel，消息延迟特定时间，例如level<span class="token operator">==</span><span class="token number">1</span>，延迟<span class="token number">1</span>s
level <span class="token operator">&gt;</span> maxLevel，则level<span class="token operator">==</span> maxLevel，例如level<span class="token operator">==</span><span class="token number">20</span>，延迟<span class="token number">2</span>h
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>例如指定的延时等级为3，则表示延迟时长为10s，即延迟等级是从1开始计数的。</p> <hr> <h3 id="_3-延时消息使用示例"><a href="#_3-延时消息使用示例" class="header-anchor">#</a> 3)延时消息使用示例</h3> <p><strong>只需要设置一个延迟级别即可，注意不是具体的延迟时间。如果设置的延迟级别超过最大值，那么将会重置为最大值。</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">InitializingBean</span><span class="token punctuation">,</span> <span class="token class-name">DisposableBean</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${rocketmq.producer.group}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> rocketmqGroupName<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${rocketmq.namesrv.addr}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> rocketmqNamesrvAddr<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${rocketmq.topic.name}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> rocketmqTopicName<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${rocketmq.producer.max.message.size}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> maxMessageSize<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">DefaultMQProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        producer<span class="token punctuation">.</span><span class="token function">setProducerGroup</span><span class="token punctuation">(</span>rocketmqGroupName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span>rocketmqNamesrvAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">setMaxMessageSize</span><span class="token punctuation">(</span>maxMessageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendDelay</span><span class="token punctuation">(</span><span class="token class-name">T</span> message<span class="token punctuation">,</span> <span class="token class-name">SendCallback</span> sendCallback<span class="token punctuation">,</span> <span class="token class-name">String</span> tags<span class="token punctuation">,</span><span class="token keyword">int</span> level<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Message</span> rocketmqMessage <span class="token operator">=</span> <span class="token function">buildRocketMqMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> tags<span class="token punctuation">)</span><span class="token punctuation">;</span>
            rocketmqMessage<span class="token punctuation">.</span><span class="token function">setDelayTimeLevel</span><span class="token punctuation">(</span>level<span class="token punctuation">)</span><span class="token punctuation">;</span>
            producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>rocketmqMessage<span class="token punctuation">,</span> sendCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;send message error ,error message is {}&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">Message</span> <span class="token function">buildRocketMqMessage</span><span class="token punctuation">(</span><span class="token class-name">T</span> message<span class="token punctuation">,</span> <span class="token class-name">String</span> tags<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UnsupportedEncodingException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Message</span> rocketmqMessage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rocketmqMessage<span class="token punctuation">.</span><span class="token function">setBody</span><span class="token punctuation">(</span><span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">RemotingHelper</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_CHARSET</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rocketmqMessage<span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span>rocketmqTopicName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        rocketmqMessage<span class="token punctuation">.</span><span class="token function">setTags</span><span class="token punctuation">(</span>tags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> rocketmqMessage<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><hr> <h3 id="_4-延迟消息实现原理"><a href="#_4-延迟消息实现原理" class="header-anchor">#</a> 4)延迟消息实现原理</h3> <p><code>RocketMQ</code>延时消息会暂存在名为<code>SCHEDULE_TOPIC_XXXX</code>的<code>Topic</code>中，并根据<code>delayTimeLevel</code>存入特定的<code>queue</code>，<code>queueId = delayTimeLevel – 1</code>，即一个<code>queue</code>只存相同延迟的消息，保证具有相同发送延迟的消息能够顺序消费。<code>broker</code>会调度地消费<code>SCHEDULE_TOPIC_XXXX</code>，将消息写入真实的<code>topic</code>。
<code>**SCHEDULE_TOPIC_XXXX**</code><strong>中</strong><code>**consumequeue**</code><strong>中的文件夹名称就是队列的名称，并且【队列名称 = 延迟等级 - 1】；如下图，在前面的例子中，我们执定消息的延迟时间为10s，对应的延迟等级是3，所以文件夹名称为【3 - 1 = 2】。</strong> <img src="https://raw.githubusercontent.com/huidongyin/DrawingBed/main/RocketMQ/202311052140997.png" alt="image.png">
延迟消息在<code>RocketMQ</code> <code>Broker</code>端的流转如下图所示：
<img src="https://raw.githubusercontent.com/huidongyin/DrawingBed/main/RocketMQ/202311052140657.png" alt="image.png"></p> <ol><li>修改消息<code>Topic</code>名称和队列信息</li></ol> <p><code>RocketMQ</code> <code>Broker</code>端在存储生产者写入的消息时，首先都会将其写入到<code>CommitLog</code>中。之后根据消息中的<code>Topic</code>信息和队列信息，将其转发到目标<code>Topic</code>的指定队列(<code>ConsumeQueue</code>)中。
由于消息一旦存储到<code>ConsumeQueue</code>中，消费者就能消费到，而延迟消息不能被立即消费，所以这里将<code>Topic</code>的名称修改为<code>SCHEDULE_TOPIC_XXXX</code>，并根据延迟级别确定要投递到哪个队列下。同时，还会将消息原来要发送到的目标<code>Topic</code>和队列信息存储到消息的属性中。</p> <ol start="2"><li>转发消息到延迟主题<code>SCHEDULE_TOPIC_XXX</code>的<code>ConsumeQueue</code>中</li></ol> <p><code>CommitLog</code>中的消息转发到<code>CosumeQueue</code>中是异步进行的。在转发过程中，会对延迟消息进行特殊处理，主要是计算这条延迟消息需要在什么时候进行投递。
<strong>投递时间 = 消息存储时间(</strong><code>**storeTimestamp**</code><strong>) + 延迟级别对应的时间。</strong>
需要注意的是，会将计算出的投递时间当做消息<code>Tag</code>的哈希值存储到<code>CosumeQueue</code>中，<code>CosumeQueue</code>单个存储单元组成结构如下图所示：
<img src="https://raw.githubusercontent.com/huidongyin/DrawingBed/main/RocketMQ/202311052141921.jpeg" alt=""></p> <ul><li><code>Commit Log Offset</code>：记录在<code>CommitLog</code>中的位置；</li> <li><code>Size</code>：记录消息的大小；</li> <li><code>Message Tag HashCode</code>：记录消息Tag的哈希值，用于消息过滤。特别的，对于延迟消息，这个字段记录的是消息的投递时间戳。这也是为什么java中<code>hashCode</code>方法返回一个int型，只占用4个字节，而这里<code>Message Tag HashCode</code>字段却设计成8个字节的原因；</li></ul> <ol start="3"><li>延迟服务消费<code>SCHEDULE_TOPIC_XXX</code>消息</li></ol> <p><code>Broker</code>内部有一个<code>ScheduleMessageService</code>类，其充当延迟服务，主要是消费<code>SCHEDULE_TOPIC_XXXX</code>中的消息，并投递到目标<code>Topic</code>中。
<code>ScheduleMessageService</code>在启动时，其会创建一个定时器<code>Timer</code>，并根据延迟级别的个数，启动对应数量的<code>TimerTask</code>，每个<code>TimerTask</code>负责一个延迟级别的消费与投递。
<strong>需要注意的是，每个</strong><code>**TimeTask**</code><strong>在检查消息是否到期时，首先检查对应队列中尚未投递第一条消息，如果这条消息没到期，那么之后的消息都不会检查。如果到期了，则进行投递，并检查之后的消息是否到期。</strong></p> <ol start="4"><li>将信息重新存储到<code>commitLog</code>中</li></ol> <p>在消息到期后，需要投递到目标<code>Topic</code>。由于在第一步已经记录了原来的<code>Topic</code>和队列信息，因此这里重新设置，再存储到<code>CommitLog</code>即可。此外，由于之前<code>Message Tag HashCode</code>字段存储的是消息的投递时间，这里需要重新计算<code>tag</code>的哈希值后再存储。</p> <ol start="5"><li>将消息投递到目标<code>Topic</code>中</li></ol> <p>这一步与第二步类似，不过由于消息的<code>Topic</code>名称已经改为了目标<code>Topic</code>。因此消息会直接投递到目标<code>Topic</code>的<code>ConsumeQueue</code>中，之后消费者即消费到这条消息。</p> <ol start="6"><li>消费者消费目标<code>Topic</code>中的数据</li></ol> <hr> <h2 id="_6-过滤消息"><a href="#_6-过滤消息" class="header-anchor">#</a> 6.过滤消息</h2> <p>过滤消息有两种方式，一种是通过<code>tags</code>的过滤方式，一种是通过<code>SQL</code>的方式。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        consumer<span class="token punctuation">.</span><span class="token function">setConsumerGroup</span><span class="token punctuation">(</span>rocketmqConsumerGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span>rocketmqNamesrvAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">setConsumeFromWhere</span><span class="token punctuation">(</span><span class="token class-name">ConsumeFromWhere</span><span class="token punctuation">.</span><span class="token constant">CONSUME_FROM_FIRST_OFFSET</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">setConsumeTimestamp</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定每次可以消费10条消息，默认为1</span>
        consumer<span class="token punctuation">.</span><span class="token function">setConsumeMessageBatchMaxSize</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定每次可以从Broker拉取40条消息，默认为32</span>
        consumer<span class="token punctuation">.</span><span class="token function">setPullBatchSize</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token function">registerListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>rocketmqTopicName<span class="token punctuation">,</span>tags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//filter message by sql .</span>
        <span class="token comment">// Don't forget to set enablePropertyFilter=true in broker</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>rocketmqTopicName<span class="token punctuation">,</span><span class="token class-name">MessageSelector</span><span class="token punctuation">.</span><span class="token function">bySql</span><span class="token punctuation">(</span><span class="token string">&quot;(TAGS is not null and TAGS in ('TagA', 'TagB'))&quot;</span> <span class="token operator">+</span><span class="token string">&quot;and (a is not null and a between 0 and 3)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>不要忘记在<code>Broker</code>的配置文件<code>broker.conf</code>中配置<code>enablePropertyFilter=true</code>。</p> <hr> <h2 id="_7-事务消息"><a href="#_7-事务消息" class="header-anchor">#</a> 7.事务消息</h2> <h3 id="_1-应用场景"><a href="#_1-应用场景" class="header-anchor">#</a> 1)应用场景</h3> <p>所谓事务消息，其实就是为了解决上下游写一致性，以及强依赖解耦，也就是完成当前操作的同时给下游发送指令，并且保证上下游要么同时成功或者同时失败，并且考虑上游的性能和RT问题做出的强调用解耦妥协。常见的应用场景有：</p> <ol><li>订单履约指令下发</li></ol> <p>用户下单成功后，给履约系统发送指令进行履约操作，下单失败不发送指令，采购缺货或者其他履约异常，反向触发订单取消或者其他兜底操作。</p> <ol start="2"><li>用户转账</li></ol> <p>用户发起转账后，交易状态短暂挂起，发送指令给银行，如果发起失败则不发送指令，发送成功后等待结果更新交易状态。</p> <ol start="3"><li>订单支付</li></ol> <p>支付发起后，当笔订单处于中间状态，给支付网关发起指令，如果发起失败则不发送指令，发送成功后等待支付网关反馈更新支付状态。</p> <hr> <h3 id="_2-使用案例"><a href="#_2-使用案例" class="header-anchor">#</a> 2)使用案例</h3> <p>我们模拟一个简单的创建订单并通过<code>RocketMQ</code>通知其他服务的场景，注意，只有本地保存订单成功才会去通知其他服务。
<img src="https://raw.githubusercontent.com/huidongyin/DrawingBed/main/RocketMQ/202311052141688.png" alt="image.png"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderService</span> <span class="token punctuation">{</span>


    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">TransactionProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> transactionProducer<span class="token punctuation">;</span>


    <span class="token comment">//事务注解</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token class-name">Order</span> order<span class="token punctuation">,</span><span class="token class-name">String</span> tId<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 1. 保存order到数据库</span>
        <span class="token comment">// 2. 写入事务日志</span>
        <span class="token class-name">OrderTransactionListener</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>tId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token comment">//前端调用，只用于往rocketMQ发送事务消息</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token class-name">Order</span> order<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">MQClientException</span> <span class="token punctuation">{</span>
        transactionProducer<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderTransactionListener</span> <span class="token keyword">implements</span> <span class="token class-name">TransactionListener</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">OrderService</span> orderService<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> transactionIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CopyOnWriteArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">LocalTransactionState</span> <span class="token function">executeLocalTransaction</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">,</span> <span class="token class-name">Object</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;开始执行本地事务..&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LocalTransactionState</span> state<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Order</span> order <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> <span class="token class-name">Order</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            orderService<span class="token punctuation">.</span><span class="token function">createOrder</span><span class="token punctuation">(</span>order<span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">getTransactionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            state <span class="token operator">=</span> <span class="token class-name">LocalTransactionState</span><span class="token punctuation">.</span><span class="token constant">COMMIT_MESSAGE</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;本地事务已经提交，事务id：{}&quot;</span><span class="token punctuation">,</span>msg<span class="token punctuation">.</span><span class="token function">getTransactionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;本地事务执行失败，异常信息：{}&quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            state <span class="token operator">=</span> <span class="token class-name">LocalTransactionState</span><span class="token punctuation">.</span><span class="token constant">ROLLBACK_MESSAGE</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">LocalTransactionState</span> <span class="token function">checkLocalTransaction</span><span class="token punctuation">(</span><span class="token class-name">MessageExt</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;开始回查本地事务状态。{}&quot;</span><span class="token punctuation">,</span>msg<span class="token punctuation">.</span><span class="token function">getTransactionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LocalTransactionState</span> state<span class="token punctuation">;</span>
        <span class="token class-name">String</span> transactionId <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getTransactionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getAndRemove</span><span class="token punctuation">(</span>transactionId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            state <span class="token operator">=</span> <span class="token class-name">LocalTransactionState</span><span class="token punctuation">.</span><span class="token constant">COMMIT_MESSAGE</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            state <span class="token operator">=</span> <span class="token class-name">LocalTransactionState</span><span class="token punctuation">.</span><span class="token constant">UNKNOW</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;结束本地事务状态查询：{}&quot;</span><span class="token punctuation">,</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">String</span> tId<span class="token punctuation">)</span><span class="token punctuation">{</span>
        transactionIds<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>tId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">getAndRemove</span><span class="token punctuation">(</span><span class="token class-name">String</span> tId<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>transactionIds<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>tId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            transactionIds<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>tId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransactionProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">InitializingBean</span><span class="token punctuation">,</span> <span class="token class-name">DisposableBean</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${rocketmq.transaction.producer.group}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> rocketmqGroupName<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${rocketmq.namesrv.addr}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> rocketmqNamesrvAddr<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${rocketmq.topic.name}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> rocketmqTopicName<span class="token punctuation">;</span>


    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TransactionMQProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransactionMQProducer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">OrderTransactionListener</span> orderTransactionListener<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        producer<span class="token punctuation">.</span><span class="token function">setProducerGroup</span><span class="token punctuation">(</span>rocketmqGroupName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span>rocketmqNamesrvAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">setSendMsgTimeout</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//producer.setExecutorService();</span>
        producer<span class="token punctuation">.</span><span class="token function">setTransactionListener</span><span class="token punctuation">(</span>orderTransactionListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">TransactionSendResult</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">T</span> message<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">MQClientException</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> producer<span class="token punctuation">.</span><span class="token function">sendMessageInTransaction</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span>rocketmqTopicName<span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><hr> <h3 id="_3-原理介绍"><a href="#_3-原理介绍" class="header-anchor">#</a> 3)原理介绍</h3> <p><strong>模型概念</strong></p> <ul><li>半消息(<code>half message</code>):半消息是一种特殊的消息类型，该状态的消息暂时不能被<code>Consumer</code>消费(消费端不可见)。当一条事务消息被成功投递到<code>Broker</code>上，但是<code>Broker</code>并没有接收到<code>Producer</code>发出的二次确认时，该事务消息就处于&quot;暂时不可被消费&quot;状态，该状态的事务消息被称为半消息。</li> <li>消息状态回查(<code>Message status check</code>):由于网络抖动闪断、<code>Producer</code>重启等原因，可能导致<code>Producer</code>向<code>Broker</code>发送的二次确认消息没有成功送达。如果<code>Broker</code>检测到某条事务消息长时间处于半消息状态，则会主动向<code>Producer</code>端发起回查操作，查询该事务消息在<code>Producer</code>端的事务状态(<code>Commit</code> 或 <code>Rollback</code>)。可以看出，<code>Message Status Chec</code>k主要用来解决分布式事务中的超时问题。</li></ul> <hr> <p><strong>执行流程</strong> <img src="https://raw.githubusercontent.com/huidongyin/DrawingBed/main/RocketMQ/202311052141343.png" alt="image.png"></p> <ol><li><code>Producer</code>向<code>Broker</code>端发送<code>Half Message</code>；</li> <li><code>Broker ACK，Half Message</code>发送成功；</li> <li><code>Producer</code>执行本地事务；</li> <li>本地事务完毕，根据事务的状态，<code>Producer</code>向<code>Broker</code>发送二次确认消息，确认该<code>Half Message</code>的<code>Commit</code>或者<code>Rollback</code>状态。<code>Broker</code>收到二次确认消息后，对于<code>Commit</code>状态，则直接发送到<code>Consumer</code>端执行消费逻辑，而对于<code>Rollback</code>则直接标记为失败，一段时间后清除，并不会发给<code>Consumer</code>。正常情况下，到此分布式事务已经完成，剩下要处理的就是超时问题，即一段时间后<code>Broker</code>仍没有收到<code>Producer</code>的二次确认消息；</li> <li>针对超时状态，<code>Broker</code>主动向<code>Producer</code>发起消息回查；</li> <li><code>Producer</code>处理回查消息，返回对应的本地事务的执行结果；</li> <li><code>Broker</code>针对回查消息的结果，执行<code>Commit</code>或<code>Rollback</code>操作，同4。</li></ol> <hr> <p><strong>事务消息设计</strong>
在<code>RocketMQ</code>事务消息的主要流程中，一阶段的消息如何对用户不可见。其中事务消息相对普通消息最大的特点就是一阶段发送的消息对用户是不可见的。那么如何做到写入消息但是对用户不可见呢？<code>RocketMQ</code>事务消息的做法是：如果消息是<code>half</code>消息，将备份原消息的主题与消息消费队列，然后改变主题为<code>RMQ_SYS_TRANS_HALF_TOPIC</code>。由于消费组未订阅该主题，故消费端无法消费<code>half</code>类型的消息，然后<code>RocketMQ</code>会开启一个定时任务，从<code>Topic</code>为<code>RMQ_SYS_TRANS_HALF_TOPIC</code>中拉取消息进行消费，根据生产者组获取一个服务提供者发送回查事务状态请求，根据事务状态来决定是提交或回滚消息。
在<code>RocketMQ</code>中，消息在服务端的存储结构如下，每条消息都会有对应的索引信息，<code>Consumer</code>通过<code>ConsumeQueue</code>这个二级索引来读取消息实体内容，其流程如下：
<img src="https://raw.githubusercontent.com/huidongyin/DrawingBed/main/RocketMQ/202311052141060.png" alt="image.png"> <code>RocketMQ</code>的具体实现策略是：写入的如果是事务消息，对消息的<code>Topic</code>和<code>Queue</code>等属性进行替换，同时将原来的<code>Topic</code>和<code>Queue</code>信息存储到消息的属性中，正因为消息主题被替换，故消息并不会转发到该原主题的消息消费队列，消费者无法感知消息的存在，不会消费。
在完成一阶段写入一条对用户不可见的消息后，二阶段如果是<code>Commit</code>操作，则需要让消息对用户可见；如果是<code>Rollback</code>则需要撤销一阶段的消息。先说<code>Rollback</code>的情况。对于Rollback，本身一阶段的消息对用户是不可见的，其实不需要真正撤销消息（实际上<code>RocketMQ</code>也无法去真正的删除一条消息，因为是顺序写文件的）。但是区别于这条消息没有确定状态（<code>Pending</code>状态，事务悬而未决），需要一个操作来标识这条消息的最终状态。<code>RocketMQ</code>事务消息方案中引入了<code>Op</code>消息的概念，用<code>Op</code>消息标识事务消息已经确定的状态（<code>Commit</code>或者<code>Rollback</code>）。如果一条事务消息没有对应的<code>Op</code>消息，说明这个事务的状态还无法确定（可能是二阶段失败了）。引入<code>Op</code>消息后，事务消息无论是<code>Commit</code>或者<code>Rollback</code>都会记录一个<code>Op</code>操作。<code>Commit</code>相对于<code>Rollback</code>只是在写入<code>Op</code>消息前创建Half消息的索引。
一阶段的<code>Half</code>消息由于是写到一个特殊的<code>Topic</code>，所以二阶段构建索引时需要读取出<code>Half</code>消息，并将<code>Topic</code>和<code>Queue</code>替换成真正的目标的<code>Topic</code>和<code>Queue</code>，之后通过一次普通消息的写入操作来生成一条对用户可见的消息。所以<code>RocketMQ</code>事务消息二阶段其实是利用了一阶段存储的消息的内容，在二阶段时恢复出一条完整的普通消息。
如果在<code>RocketMQ</code>事务消息的二阶段过程中失败了，例如在做<code>Commit</code>操作时，出现网络问题导致<code>Commit</code>失败，那么需要通过一定的策略使这条消息最终被<code>Commit</code>。<code>RocketMQ</code>采用了一种补偿机制，称为“回查”。<code>Broker</code>端对未确定状态的消息发起回查，将消息发送到对应的<code>Producer</code>端（同一个<code>Group</code>的<code>Producer</code>），由<code>Producer</code>根据消息来检查本地事务的状态，进而执行Commit或者<code>Rollback</code>。<code>Broker</code>端通过对比<code>Half</code>消息和<code>Op</code>消息进行事务消息的回查并且推进<code>CheckPoint</code>（记录哪些事务消息的状态是确定的）。
需要注意的是，<code>rocketmq</code>并不会无休止的的信息事务状态回查，默认回查15次，如果15次回查还是无法得知事务状态，<code>rocketmq</code>默认回滚该消息。</p> <hr> <h2 id="_8-权限控制"><a href="#_8-权限控制" class="header-anchor">#</a> 8.权限控制</h2> <p>权限控制（<code>ACL</code>）主要为<code>RocketMQ</code>提供<code>Topic</code>资源级别的用户访问控制。用户在使用<code>RocketMQ</code>权限控制时，可以在<code>Client</code>客户端通过 <code>RPCHook</code>注入<code>AccessKey</code>和<code>SecretKey</code>签名；同时，将对应的权限控制属性（包括<code>Topic</code>访问权限、<code>IP</code>白名单和<code>AccessKey</code>和<code>SecretKey</code>签名等）设置在<code>$ROCKETMQ_HOME/conf/plain_acl.yml</code>的配置文件中。<code>Broker</code>端对<code>AccessKey</code>所拥有的权限进行校验，校验不过，抛出异常。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">InitializingBean</span><span class="token punctuation">,</span> <span class="token class-name">DisposableBean</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${rocketmq.producer.group}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> rocketmqGroupName<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${rocketmq.namesrv.addr}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> rocketmqNamesrvAddr<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${rocketmq.topic.name}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> rocketmqTopicName<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${rocketmq.producer.max.message.size}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> maxMessageSize<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${rocketmq.access.key}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> accessKey<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${rocketmq.secret.key}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> secretKey<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">DefaultMQProducer</span> producer<span class="token punctuation">;</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token function">getRPCHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">setProducerGroup</span><span class="token punctuation">(</span>rocketmqGroupName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span>rocketmqNamesrvAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">setMaxMessageSize</span><span class="token punctuation">(</span>maxMessageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">RPCHook</span> <span class="token function">getRPCHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AclClientRPCHook</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SessionCredentials</span><span class="token punctuation">(</span>accessKey<span class="token punctuation">,</span> secretKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><blockquote><p>消费端代码同发送端。</p></blockquote> <p>如果要在自己的客户端中使用<code>RocketMQ</code>的<code>ACL</code>功能，还需要引入一个单独的依赖包。</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.rocketmq<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>rocketmq-acl<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.8.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>而<code>Broker</code>端具体的配置信息可以参见源码包下<code>docs/cn/acl/user_guide.md</code>。主要是在<code>broker.conf</code>中打开<code>acl</code>的标志：<code>aclEnable=true</code>。然后就可以用<code>plain_acl.yml</code>来进行权限配置了。并且这个配置文件是热加载的，也就是说要修改配置时，只要修改配置文件就可以了，不用重启<code>Broker</code>服务。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment">#全局白名单，不受ACL控制</span>
<span class="token comment">#通常需要将主从架构中的所有节点加进来</span>
<span class="token key atrule">globalWhiteRemoteAddresses</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> 10.10.103.*
<span class="token punctuation">-</span> 192.168.0.*
<span class="token key atrule">accounts</span><span class="token punctuation">:</span>
<span class="token comment">#第一个账户</span>
<span class="token punctuation">-</span> <span class="token key atrule">accessKey</span><span class="token punctuation">:</span> RocketMQ
  <span class="token key atrule">secretKey</span><span class="token punctuation">:</span> <span class="token number">12345678</span>
  <span class="token key atrule">whiteRemoteAddress</span><span class="token punctuation">:</span>
  <span class="token key atrule">admin</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">defaultTopicPerm</span><span class="token punctuation">:</span> DENY <span class="token comment">#默认Topic访问策略是拒绝</span>
  <span class="token key atrule">defaultGroupPerm</span><span class="token punctuation">:</span> SUB <span class="token comment">#默认Group访问策略是只允许订阅</span>
  <span class="token key atrule">topicPerms</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> topicA=DENY <span class="token comment">#topicA拒绝</span>
<span class="token punctuation">-</span> topicB=PUB<span class="token punctuation">|</span>SUB <span class="token comment">#topicB允许发布和订阅消息</span>
<span class="token punctuation">-</span> topicC=SUB <span class="token comment">#topicC只允许订阅</span>
  <span class="token key atrule">groupPerms</span><span class="token punctuation">:</span>
   <span class="token comment"># the group should convert to retry topic</span>
  <span class="token punctuation">-</span> groupA=DENY
  <span class="token punctuation">-</span> groupB=PUB<span class="token punctuation">|</span>SUB
  <span class="token punctuation">-</span> groupC=SUB
<span class="token comment">#第二个账户，只要是来自192.168.1.*的IP，就可以访问所有资源</span>
<span class="token punctuation">-</span> <span class="token key atrule">accessKey</span><span class="token punctuation">:</span> rocketmq2
  <span class="token key atrule">secretKey</span><span class="token punctuation">:</span> <span class="token number">12345678</span>
  <span class="token key atrule">whiteRemoteAddress</span><span class="token punctuation">:</span> 192.168.1.*
   <span class="token comment"># if it is admin, it could access all resources</span>
  <span class="token key atrule">admin</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><hr></div></div>  <div class="page-edit"><!----> <div class="tags"><a href="/tags/?tag=RocketMQ" title="标签">#RocketMQ</a><a href="/tags/?tag=%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97" title="标签">#消息队列</a></div> <div class="last-updated"><span class="prefix">lastUpdateTime:</span> <span class="time">2024/04/10, 14:00:42</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/rocketmq/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">RocketMQ安装部署</div></a> <a href="/pages/0d520535-8bff-3ea6-aabe-bc4ff4008127/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">RocketMQ源码环境搭建</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/rocketmq/" class="prev">RocketMQ安装部署</a></span> <span class="next"><a href="/pages/0d520535-8bff-3ea6-aabe-bc4ff4008127/">RocketMQ源码环境搭建</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/a2a9d5e6-b580-3ee0-b2c2-5b1557852fd5/"><div>
            小米新零售BI数据领域建设思考与沉淀
            <!----></div></a> <span class="date">01-01</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/aboutme/"><div>
            About Me
            <!----></div></a> <span class="date">9月11日</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/457c4495-1768-3af4-bc65-112ed5748187/"><div>
            PPT-注重内容结构
            <!----></div></a> <span class="date">9月11日</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:huidong.yin247203@gamil.com" title="Email" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/huidongyin/" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://gitee.com/yin_huidong/" title="Gitee" target="_blank" class="iconfont icon-gitee"></a><a href="https://music.163.com/#/playlist?id=755597173" title="Music" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2023-2024
    <span>huidong.yin | <a href="https://huidongyin.github.io" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <div class="body-bg" style="background:url() center center / cover no-repeat;opacity:0.5;"></div> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.c004ce88.js" defer></script><script src="/assets/js/4.beb5e9d1.js" defer></script><script src="/assets/js/1.39930c36.js" defer></script><script src="/assets/js/3.95e91fe0.js" defer></script><script src="/assets/js/152.dff556f3.js" defer></script>
  </body>
</html>
